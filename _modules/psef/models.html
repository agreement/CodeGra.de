

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>psef.models &mdash; CodeGra.de 1.0 documentation</title>
  

  
  
  
  

  

  
  
    

  

  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link href="../../_static/style.css" rel="stylesheet" type="text/css">


  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> CodeGra.de
          

          
          </a>

          
            
            
              <div class="version">
                1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../manual.html">User Manual CodeGra.de</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../code.html">Code documentation of psef</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../running.html">How to run CodeGra.de</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">CodeGra.de</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
          <li><a href="../psef.html">psef</a> &raquo;</li>
        
      <li>psef.models</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for psef.models</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">This module defines all the objects in the database in their relation.</span>

<span class="sd">:license: AGPLv3, see LICENSE for details.</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="c1"># TODO: Split this file into one file per model.</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">enum</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">typing</span> <span class="k">as</span> <span class="nn">t</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="k">import</span> <span class="n">shuffle</span>
<span class="kn">from</span> <span class="nn">operator</span> <span class="k">import</span> <span class="n">itemgetter</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">cycle</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span>

<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">orm</span><span class="p">,</span> <span class="n">event</span>
<span class="kn">from</span> <span class="nn">itsdangerous</span> <span class="k">import</span> <span class="n">BadSignature</span><span class="p">,</span> <span class="n">URLSafeTimedSerializer</span>
<span class="kn">from</span> <span class="nn">werkzeug.utils</span> <span class="k">import</span> <span class="n">cached_property</span>
<span class="kn">from</span> <span class="nn">flask_sqlalchemy</span> <span class="k">import</span> <span class="n">SQLAlchemy</span>
<span class="kn">from</span> <span class="nn">sqlalchemy_utils</span> <span class="k">import</span> <span class="n">PasswordType</span><span class="p">,</span> <span class="n">force_auto_coercion</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql.expression</span> <span class="k">import</span> <span class="n">and_</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">false</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm.collections</span> <span class="k">import</span> <span class="n">attribute_mapped_collection</span>

<span class="kn">import</span> <span class="nn">psef</span>  <span class="c1"># pylint: disable=cyclic-import</span>
<span class="kn">from</span> <span class="nn">psef</span> <span class="k">import</span> <span class="n">current_app</span>

<span class="kn">from</span> <span class="nn">.model_types</span> <span class="k">import</span> <span class="n">T</span><span class="p">,</span> <span class="n">MyDb</span><span class="p">,</span> <span class="n">DbColumn</span>  <span class="c1"># pylint: disable=unused-import</span>

<span class="n">db</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span>  <span class="c1"># pylint: disable=invalid-name</span>
    <span class="s1">&#39;MyDb&#39;</span><span class="p">,</span>
    <span class="n">SQLAlchemy</span><span class="p">(</span><span class="n">session_options</span><span class="o">=</span><span class="p">{</span>
        <span class="s1">&#39;autocommit&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
        <span class="s1">&#39;autoflush&#39;</span><span class="p">:</span> <span class="kc">False</span>
    <span class="p">})</span>
<span class="p">)</span>


<div class="viewcode-block" id="init_app"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.init_app">[docs]</a><span class="k">def</span> <span class="nf">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Initialize the database connections and set some listeners.</span>

<span class="sd">    :param app: The flask app to initialize for.</span>
<span class="sd">    :returns: Nothing</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">db</span><span class="o">.</span><span class="n">init_app</span><span class="p">(</span><span class="n">app</span><span class="p">)</span>
    <span class="n">force_auto_coercion</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;_USING_SQLITE&#39;</span><span class="p">]:</span>  <span class="c1"># pragma: no cover</span>
        <span class="k">with</span> <span class="n">app</span><span class="o">.</span><span class="n">app_context</span><span class="p">():</span>

            <span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">engine</span><span class="p">,</span> <span class="s2">&quot;connect&quot;</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">__do_connect</span><span class="p">(</span><span class="n">dbapi_connection</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="n">_</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># disable pysqlite&#39;s emitting of the BEGIN statement entirely.</span>
                <span class="c1"># also stops it from emitting COMMIT before any DDL.</span>
                <span class="n">dbapi_connection</span><span class="o">.</span><span class="n">isolation_level</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">dbapi_connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s1">&#39;pragma foreign_keys=ON&#39;</span><span class="p">)</span>

            <span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">engine</span><span class="p">,</span> <span class="s2">&quot;begin&quot;</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">__do_begin</span><span class="p">(</span><span class="n">conn</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># emit our own BEGIN</span>
                <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;BEGIN&quot;</span><span class="p">)</span></div>


<span class="n">UUID_LENGTH</span> <span class="o">=</span> <span class="mi">36</span>

<span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>  <span class="c1"># pragma: no cover:</span>
    <span class="kn">from</span> <span class="nn">psef.model_types</span> <span class="k">import</span> <span class="n">_MyQuery</span><span class="p">,</span> <span class="n">Base</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">Base</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Model</span>  <span class="c1"># pylint: disable=invalid-name</span>

<span class="n">permissions</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span>  <span class="c1"># pylint: disable=invalid-name</span>
    <span class="s1">&#39;roles-permissions&#39;</span><span class="p">,</span>
    <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;permission_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Permission.id&#39;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;CASCADE&#39;</span><span class="p">)</span>
    <span class="p">),</span>
    <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;role_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Role.id&#39;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;CASCADE&#39;</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">course_permissions</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span>  <span class="c1"># pylint: disable=invalid-name</span>
    <span class="s1">&#39;course_roles-permissions&#39;</span><span class="p">,</span>
    <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;permission_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Permission.id&#39;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;CASCADE&#39;</span><span class="p">)</span>
    <span class="p">),</span>
    <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;course_role_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Course_Role.id&#39;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;CASCADE&#39;</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">user_course</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span>  <span class="c1"># pylint: disable=invalid-name</span>
    <span class="s1">&#39;users-courses&#39;</span><span class="p">,</span>
    <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;course_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Course_Role.id&#39;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;CASCADE&#39;</span><span class="p">)</span>
    <span class="p">),</span>
    <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;user_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;User.id&#39;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;CASCADE&#39;</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">work_rubric_item</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span>  <span class="c1"># pylint: disable=invalid-name</span>
    <span class="s1">&#39;work_rubric_item&#39;</span><span class="p">,</span>
    <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;work_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Work.id&#39;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;CASCADE&#39;</span><span class="p">)</span>
    <span class="p">),</span>
    <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;rubricitem_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;RubricItem.id&#39;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;CASCADE&#39;</span><span class="p">)</span>
    <span class="p">)</span>
<span class="p">)</span>


<div class="viewcode-block" id="LTIProvider"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.LTIProvider">[docs]</a><span class="k">class</span> <span class="nc">LTIProvider</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class defines the handshake with an LTI</span>

<span class="sd">    :ivar key: The OAuth consumer key for this LTI provider.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">query</span>  <span class="c1"># type: t.ClassVar[_MyQuery[&#39;LTIProvider&#39;]]</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;LTIProvider&#39;</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">UUID_LENGTH</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<div class="viewcode-block" id="LTIProvider.__init__"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.LTIProvider.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
        <span class="n">public_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>

        <span class="k">while</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="n">LTIProvider</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">public_id</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
        <span class="p">)</span><span class="o">.</span><span class="n">scalar</span><span class="p">():</span>  <span class="c1"># pragma: no cover</span>
            <span class="n">public_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">public_id</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">secret</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The OAuth consumer secret for this LTIProvider.</span>

<span class="sd">        :getter: Get the OAuth secret.</span>
<span class="sd">        :setter: Impossible as all secrets are fixed during startup of</span>
<span class="sd">            codegra.de</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;LTI_CONSUMER_KEY_SECRETS&#39;</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">]</span></div>


<div class="viewcode-block" id="AssignmentAssignedGrader"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.AssignmentAssignedGrader">[docs]</a><span class="k">class</span> <span class="nc">AssignmentAssignedGrader</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The class creates the link between an :class:`User` and an</span>
<span class="sd">    :class:`Assignment`.</span>

<span class="sd">    The user linked to the assignment is an assigned grader. In this link the</span>
<span class="sd">    weight is the weight this user was given when assigning.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">query</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">ClassVar</span><span class="p">[</span><span class="n">_MyQuery</span><span class="p">[</span><span class="s1">&#39;AssignmentAssignedGrader&#39;</span><span class="p">]]</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">query</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;AssignmentAssignedGrader&#39;</span>
    <span class="n">weight</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;weight&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;User_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;User.id&#39;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;CASCADE&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">assignment_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;Assignment_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Assignment.id&#39;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;CASCADE&#39;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">PrimaryKeyConstraint</span><span class="p">(</span><span class="n">assignment_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">),</span> <span class="p">)</span></div>


<div class="viewcode-block" id="AssignmentGraderDone"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.AssignmentGraderDone">[docs]</a><span class="k">class</span> <span class="nc">AssignmentGraderDone</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class creates the link between an :class:`User` and an</span>
<span class="sd">    :class:`Assignment` that exists only when the grader is done.</span>

<span class="sd">    If a user is linked to the assignment this indicates that this user is done</span>
<span class="sd">    with grading.</span>

<span class="sd">    :ivar user_id: The id of the user that is linked.</span>
<span class="sd">    :ivar ~.AssignmentGraderDone.assignment_id: The id of the assignment that</span>
<span class="sd">        is linked.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">query</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">ClassVar</span><span class="p">[</span><span class="n">_MyQuery</span><span class="p">[</span><span class="s1">&#39;AssignmentGraderDone&#39;</span><span class="p">]]</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">query</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;AssignmentGraderDone&#39;</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;User_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;User.id&#39;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;CASCADE&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">assignment_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;Assignment_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Assignment.id&#39;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;CASCADE&#39;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">PrimaryKeyConstraint</span><span class="p">(</span><span class="n">assignment_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">),</span> <span class="p">)</span></div>


<div class="viewcode-block" id="AssignmentResult"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.AssignmentResult">[docs]</a><span class="k">class</span> <span class="nc">AssignmentResult</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The class creates the link between an :class:`User` and an</span>
<span class="sd">    :class:`Assignment` in the database and the external users LIS sourcedid.</span>

<span class="sd">    :ivar sourcedid: The ``sourcedid`` for this user for this assignment.</span>
<span class="sd">    :ivar ~.AssignmentResult.user_id: The id of the user this belongs to.</span>
<span class="sd">    :ivar ~.AssignmentResult.assignment_id: The id of the assignment this</span>
<span class="sd">        belongs to.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">query</span>  <span class="c1"># type: t.ClassVar[_MyQuery[&#39;AssignmentResult&#39;]]</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;AssignmentResult&#39;</span>
    <span class="n">sourcedid</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;sourcedid&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">)</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;User_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;User.id&#39;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;CASCADE&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">assignment_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;Assignment_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Assignment.id&#39;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;CASCADE&#39;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">PrimaryKeyConstraint</span><span class="p">(</span><span class="n">assignment_id</span><span class="p">,</span> <span class="n">user_id</span><span class="p">),</span> <span class="p">)</span></div>


<div class="viewcode-block" id="Permission"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.Permission">[docs]</a><span class="k">class</span> <span class="nc">Permission</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class defines permissions by names that are checked in certain</span>
<span class="sd">    APIs.</span>

<span class="sd">    A permission can be a global- or a course- permission. Global permissions</span>
<span class="sd">    describe the ability to do something general, e.g. create a course or the</span>
<span class="sd">    usage of snippets. These permissions are connected to a :class:`Role` which</span>
<span class="sd">    is hold be a :class:`User`. Similarly course permissions are bound to a</span>
<span class="sd">    :class:`CourseRole`. These roles are assigned to users only in the context</span>
<span class="sd">    of a single :class:`Course`. Thus a user can hold different permissions in</span>
<span class="sd">    different courses.</span>

<span class="sd">    :ivar name: The, unique, name of this permission.</span>
<span class="sd">    :ivar default_value: The default value for this permission.</span>
<span class="sd">    :ivar course_permission: Indicates if this permission is for course</span>
<span class="sd">        specific actions. If this is the case a user can have this permission</span>
<span class="sd">        for a subset of all the courses. If ``course_permission`` is ``False``</span>
<span class="sd">        this permission is global for the entire site.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">query</span>  <span class="c1"># type: t.ClassVar[_MyQuery[&#39;Permission&#39;]]</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;Permission&#39;</span>

    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">default_value</span><span class="p">:</span> <span class="nb">bool</span>  <span class="c1"># NOQA</span>
    <span class="n">default_value</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;default_value&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">course_permission</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;course_permission&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="AbstractRole"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.AbstractRole">[docs]</a><span class="k">class</span> <span class="nc">AbstractRole</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;An abstract class that implements all functionality a role should have.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="AbstractRole.__init__"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.AbstractRole.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">_permissions</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">MutableMapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Permission</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_has_permission_cache</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">MutableMapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">if</span> <span class="n">_permissions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_permissions</span> <span class="o">=</span> <span class="n">_permissions</span></div>

    <span class="nd">@property</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">id</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The id of this role.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@property</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The name of this role.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@property</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">MutableMapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Permission</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;The permissions this role has a connection to.</span>

<span class="sd">        A connection means this role has the permission if, and only if, the</span>
<span class="sd">        ``default_value`` of this permission is ``False``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

    <span class="nd">@property</span>
    <span class="nd">@abc</span><span class="o">.</span><span class="n">abstractmethod</span>
    <span class="k">def</span> <span class="nf">uses_course_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Does this role use course permissions or global permissions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span>

<div class="viewcode-block" id="AbstractRole.setup_has_permission_cache"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.AbstractRole.setup_has_permission_cache">[docs]</a>    <span class="nd">@orm</span><span class="o">.</span><span class="n">reconstructor</span>
    <span class="k">def</span> <span class="nf">setup_has_permission_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Reset permission cache to an empty object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_has_permission_cache</span> <span class="o">=</span> <span class="p">{}</span></div>

<div class="viewcode-block" id="AbstractRole.set_permission"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.AbstractRole.set_permission">[docs]</a>    <span class="k">def</span> <span class="nf">set_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">perm</span><span class="p">:</span> <span class="n">Permission</span><span class="p">,</span> <span class="n">should_have</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set the given :class:`Permission` to the given value.</span>

<span class="sd">        :param should_have: If this role should have this permission</span>
<span class="sd">        :param perm: The permission this role should (not) have</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="n">perm</span><span class="o">.</span><span class="n">course_permission</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">uses_course_permissions</span>

        <span class="k">if</span> <span class="n">perm</span><span class="o">.</span><span class="n">default_value</span> <span class="o">^</span> <span class="n">should_have</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_permissions</span><span class="p">[</span><span class="n">perm</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">perm</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_permissions</span><span class="p">[</span><span class="n">perm</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_has_permission_cache</span><span class="p">[</span><span class="n">perm</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">should_have</span></div>

<div class="viewcode-block" id="AbstractRole.has_permission"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.AbstractRole.has_permission">[docs]</a>    <span class="k">def</span> <span class="nf">has_permission</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">permission</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Permission</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check whether this course role has the specified</span>
<span class="sd">        :class:`Permission`.</span>

<span class="sd">        :param permission: The permission or permission name</span>
<span class="sd">        :returns: True if the course role has the permission</span>

<span class="sd">        :raises KeyError: If the permission parameter is a string and no</span>
<span class="sd">            permission with this name exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">permission</span><span class="p">,</span> <span class="n">Permission</span><span class="p">):</span>
            <span class="n">permission_name</span> <span class="o">=</span> <span class="n">permission</span><span class="o">.</span><span class="n">name</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">permission_name</span> <span class="o">=</span> <span class="n">permission</span>

        <span class="k">if</span> <span class="n">permission_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_permission_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_has_permission_cache</span><span class="p">[</span><span class="n">permission_name</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">permission_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_permissions</span><span class="p">:</span>
            <span class="n">perm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_permissions</span><span class="p">[</span><span class="n">permission_name</span><span class="p">]</span>
            <span class="n">res</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">perm</span><span class="o">.</span><span class="n">default_value</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">permission</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">permission</span> <span class="o">=</span> <span class="n">Permission</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span>
                    <span class="n">course_permission</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uses_course_permissions</span><span class="p">,</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">permission</span><span class="p">,</span>
                <span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">permission</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                    <span class="n">f</span><span class="s1">&#39;The permission &quot;</span><span class="si">{permission_name}</span><span class="s1">&quot; does not exist&#39;</span>
                <span class="p">)</span>

            <span class="n">res</span> <span class="o">=</span> <span class="n">permission</span><span class="o">.</span><span class="n">default_value</span> <span class="ow">and</span> <span class="p">(</span>
                <span class="n">permission</span><span class="o">.</span><span class="n">course_permission</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">uses_course_permissions</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_has_permission_cache</span><span class="p">[</span><span class="n">permission_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span>
        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="AbstractRole.get_all_permissions"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.AbstractRole.get_all_permissions">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get all course :class:`permissions` for this course role.</span>

<span class="sd">        :returns: A name boolean mapping where the name is the name of the</span>
<span class="sd">                  permission and the value indicates if this user has this</span>
<span class="sd">                  permission.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">perms</span> <span class="o">=</span> <span class="n">Permission</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span>
            <span class="n">course_permission</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">uses_course_permissions</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_permissions</span><span class="p">)</span> <span class="o">^</span> <span class="n">p</span><span class="o">.</span><span class="n">default_value</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">perms</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="AbstractRole.__to_json__"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.AbstractRole.__to_json__">[docs]</a>    <span class="k">def</span> <span class="nf">__to_json__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">MutableMapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Creates a JSON serializable representation of a role.</span>

<span class="sd">        This object will look like this:</span>

<span class="sd">        .. code:: python</span>

<span class="sd">            {</span>
<span class="sd">                &#39;id&#39;:    int, # The id of this role.</span>
<span class="sd">                &#39;name&#39;:  str, # The name of this role.</span>
<span class="sd">            }</span>

<span class="sd">        :returns: An object as described above.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="p">}</span></div></div>


<div class="viewcode-block" id="CourseRole"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.CourseRole">[docs]</a><span class="k">class</span> <span class="nc">CourseRole</span><span class="p">(</span><span class="n">AbstractRole</span><span class="p">,</span> <span class="n">Base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A course role is used to describe the abilities of a :class:`User` in a</span>
<span class="sd">    :class:`Course`.</span>

<span class="sd">    :ivar name: The name of this role in the course.</span>
<span class="sd">    :ivar ~.CourseRole.course_id: The :py:class:`Course` this role belongs to.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">query</span>  <span class="c1"># type: t.ClassVar[_MyQuery[&#39;CourseRole&#39;]]</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;Course_Role&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">)</span>
    <span class="n">course_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;Course_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Course.id&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">_permissions</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">MutableMapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Permission</span><span class="p">]</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="s1">&#39;Permission&#39;</span><span class="p">,</span>
        <span class="n">collection_class</span><span class="o">=</span><span class="n">attribute_mapped_collection</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
        <span class="n">secondary</span><span class="o">=</span><span class="n">course_permissions</span>
    <span class="p">)</span>

    <span class="c1"># Old syntax used to please sphinx</span>
    <span class="n">course</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="s1">&#39;Course&#39;</span><span class="p">,</span> <span class="n">foreign_keys</span><span class="o">=</span><span class="n">course_id</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;roles&quot;</span>
    <span class="p">)</span>  <span class="c1"># type: Course</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">uses_course_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>

<div class="viewcode-block" id="CourseRole.__init__"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.CourseRole.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">course</span><span class="p">:</span> <span class="s1">&#39;Course&#39;</span><span class="p">,</span>
        <span class="n">_permissions</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">MutableMapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Permission</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">_permissions</span><span class="o">=</span><span class="n">_permissions</span><span class="p">)</span>

        <span class="c1"># Mypy doesn&#39;t get the sqlalchemy magic</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">course</span> <span class="o">=</span> <span class="n">course</span>  <span class="c1"># type: ignore</span></div>

<div class="viewcode-block" id="CourseRole.__to_json__"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.CourseRole.__to_json__">[docs]</a>    <span class="k">def</span> <span class="nf">__to_json__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">MutableMapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Creates a JSON serializable representation of this object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__to_json__</span><span class="p">()</span>
        <span class="n">res</span><span class="p">[</span><span class="s1">&#39;course&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">course</span>
        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="CourseRole.get_initial_course_role"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.CourseRole.get_initial_course_role">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_initial_course_role</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="s1">&#39;CourseRole&#39;</span><span class="p">],</span>
                                <span class="n">course</span><span class="p">:</span> <span class="s1">&#39;Course&#39;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;CourseRole&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the initial course role for a given course.</span>

<span class="sd">        :param course: The course to get the initial role for.</span>
<span class="sd">        :returns: A course role that should be the role for the user creating</span>
<span class="sd">            the course.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;_DEFAULT_COURSE_ROLES&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="s1">&#39;initial_role&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">course</span><span class="o">=</span><span class="n">course</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No initial course role found&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="CourseRole.get_default_course_roles"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.CourseRole.get_default_course_roles">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_default_course_roles</span><span class="p">(</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">MutableMapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Permission</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Get all default course roles as specified in the config and their</span>
<span class="sd">        permissions (:class:`Permission`).</span>


<span class="sd">        .. code:: python</span>

<span class="sd">            {</span>
<span class="sd">                &#39;student&#39;: {</span>
<span class="sd">                    &#39;can_edit_assignment_info&#39;: &lt;Permission-object&gt;,</span>
<span class="sd">                    &#39;can_submit_own_work&#39;: &lt;Permission-object&gt;</span>
<span class="sd">                }</span>
<span class="sd">            }</span>

<span class="sd">        :returns: A name dict mapping where the name is the name of the</span>
<span class="sd">            course-role and the dict is name permission mapping between the</span>
<span class="sd">            name of a permission and the permission object. See above for an</span>
<span class="sd">            example.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;_DEFAULT_COURSE_ROLES&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">perms</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Permission</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">Permission</span><span class="o">.</span><span class="n">query</span><span class="o">.</span>
                <span class="n">filter_by</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
                    <span class="n">course_permission</span><span class="o">=</span><span class="kc">True</span>
                <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">r_perms</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">perms_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="s1">&#39;permissions&#39;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">perm</span> <span class="ow">in</span> <span class="n">perms</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">bool</span><span class="p">(</span><span class="n">perm</span><span class="o">.</span><span class="n">default_value</span><span class="p">)</span> <span class="o">^</span> <span class="nb">bool</span><span class="p">(</span><span class="n">perm</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">perms_set</span><span class="p">):</span>
                    <span class="n">r_perms</span><span class="p">[</span><span class="n">perm</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">perm</span>

            <span class="n">res</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">r_perms</span>
        <span class="k">return</span> <span class="n">res</span></div></div>


<div class="viewcode-block" id="Role"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.Role">[docs]</a><span class="k">class</span> <span class="nc">Role</span><span class="p">(</span><span class="n">AbstractRole</span><span class="p">,</span> <span class="n">Base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A role defines the set of global permissions :class:`Permission` of a</span>
<span class="sd">    :class:`User`.</span>

<span class="sd">    :ivar name: The name of the global role.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">query</span>  <span class="c1"># type: t.ClassVar[_MyQuery[&#39;Role&#39;]]</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;Role&#39;</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">_permissions</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">MutableMapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Permission</span><span class="p">]</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="s1">&#39;Permission&#39;</span><span class="p">,</span>
        <span class="n">collection_class</span><span class="o">=</span><span class="n">attribute_mapped_collection</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">),</span>
        <span class="n">secondary</span><span class="o">=</span><span class="n">permissions</span><span class="p">,</span>
        <span class="n">backref</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">backref</span><span class="p">(</span><span class="s1">&#39;roles&#39;</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;dynamic&#39;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">uses_course_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span></div>


<div class="viewcode-block" id="User"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.User">[docs]</a><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class describes a user of the system.</span>

<span class="sd">    :ivar lti_user_id: The id of this user in a LTI consumer.</span>
<span class="sd">    :ivar name: The name of this user.</span>
<span class="sd">    :ivar role_id: The id of the role this user has.</span>
<span class="sd">    :ivar courses: A mapping between course_id and course-role for all courses</span>
<span class="sd">        this user is currently enrolled.</span>
<span class="sd">    :ivar email: The e-mail of this user.</span>
<span class="sd">    :ivar password: The password of this user, it is automatically hashed.</span>
<span class="sd">    :ivar assignment_results: The way this user can do LTI grade passback.</span>
<span class="sd">    :ivar assignments_assigned: A mapping between assignment_ids and</span>
<span class="sd">        :py:class:`AssignmentAssignedGrader` objects.</span>
<span class="sd">    :ivar reset_email_on_lti: Determines if the email should be reset on the</span>
<span class="sd">        next LTI launch.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Python 3 implicitly set __hash__ to None if we override __eq__</span>
    <span class="c1"># We set it back to its default implementation</span>
    <span class="fm">__hash__</span> <span class="o">=</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__hash__</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;User&quot;</span>

    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># All stuff for LTI</span>
    <span class="n">lti_user_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">)</span>
    <span class="n">active</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;active&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">role_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;Role_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Role.id&#39;</span><span class="p">))</span>
    <span class="n">courses</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">MutableMapping</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">CourseRole</span><span class="p">]</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="s1">&#39;CourseRole&#39;</span><span class="p">,</span>
        <span class="n">collection_class</span><span class="o">=</span><span class="n">attribute_mapped_collection</span><span class="p">(</span><span class="s1">&#39;course_id&#39;</span><span class="p">),</span>
        <span class="n">secondary</span><span class="o">=</span><span class="n">user_course</span><span class="p">,</span>
        <span class="n">backref</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">backref</span><span class="p">(</span><span class="s1">&#39;users&#39;</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;dynamic&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">username</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;username&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span>
        <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">reset_token</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;reset_token&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">UUID_LENGTH</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">reset_email_on_lti</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;reset_email_on_lti&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span>
        <span class="n">server_default</span><span class="o">=</span><span class="n">false</span><span class="p">(),</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">email</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;email&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">password</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;password&#39;</span><span class="p">,</span>
        <span class="n">PasswordType</span><span class="p">(</span><span class="n">schemes</span><span class="o">=</span><span class="p">[</span>
            <span class="s1">&#39;pbkdf2_sha512&#39;</span><span class="p">,</span>
        <span class="p">],</span> <span class="n">deprecated</span><span class="o">=</span><span class="p">[]),</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>

    <span class="n">assignments_assigned</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">MutableMapping</span><span class="p">[</span>
        <span class="nb">int</span><span class="p">,</span> <span class="n">AssignmentAssignedGrader</span>
    <span class="p">]</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="s1">&#39;AssignmentAssignedGrader&#39;</span><span class="p">,</span>
        <span class="n">collection_class</span><span class="o">=</span><span class="n">attribute_mapped_collection</span><span class="p">(</span><span class="s1">&#39;assignment_id&#39;</span><span class="p">),</span>
        <span class="n">backref</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">backref</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;select&#39;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">assignment_results</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">MutableMapping</span><span class="p">[</span>
        <span class="nb">int</span><span class="p">,</span> <span class="n">AssignmentResult</span>
    <span class="p">]</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="s1">&#39;AssignmentResult&#39;</span><span class="p">,</span>
        <span class="n">collection_class</span><span class="o">=</span><span class="n">attribute_mapped_collection</span><span class="p">(</span><span class="s1">&#39;assignment_id&#39;</span><span class="p">),</span>
        <span class="n">backref</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">backref</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;select&#39;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">role</span><span class="p">:</span> <span class="n">Role</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span><span class="s1">&#39;Role&#39;</span><span class="p">,</span> <span class="n">foreign_keys</span><span class="o">=</span><span class="n">role_id</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;select&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="User.__eq__"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.User.__eq__">[docs]</a>    <span class="k">def</span> <span class="nf">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">other</span><span class="p">,</span> <span class="n">User</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">id</span></div>

<div class="viewcode-block" id="User.__ne__"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.User.__ne__">[docs]</a>    <span class="k">def</span> <span class="nf">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span></div>

<div class="viewcode-block" id="User.has_permission"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.User.has_permission">[docs]</a>    <span class="k">def</span> <span class="nf">has_permission</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">permission</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Permission</span><span class="p">],</span>
        <span class="n">course_id</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="s1">&#39;Course&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check whether this user has the specified global or course</span>
<span class="sd">        :class:`Permission`.</span>

<span class="sd">        To check a course permission the course_id has to be set.</span>

<span class="sd">        :param permission: The permission or permission name</span>
<span class="sd">        :param course_id: The course or course id</span>
<span class="sd">        :returns: Whether the role has the permission or not</span>

<span class="sd">        :raises KeyError: If the permission parameter is a string and no</span>
<span class="sd">                         permission with this name exists.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">active</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">course_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">role</span><span class="o">.</span><span class="n">has_permission</span><span class="p">(</span><span class="n">permission</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">course_id</span><span class="p">,</span> <span class="n">Course</span><span class="p">):</span>
                <span class="n">course_id</span> <span class="o">=</span> <span class="n">course_id</span><span class="o">.</span><span class="n">id</span>

            <span class="k">if</span> <span class="n">course_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">courses</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">courses</span><span class="p">[</span><span class="n">course_id</span><span class="p">]</span><span class="o">.</span><span class="n">has_permission</span><span class="p">(</span><span class="n">permission</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">permission</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">Permission</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">permission</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span>
                        <span class="n">f</span><span class="s1">&#39;The permission &quot;</span><span class="si">{permission}</span><span class="s1">&quot; does not exist&#39;</span>
                    <span class="p">)</span>
            <span class="k">return</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="User.get_permissions_in_courses"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.User.get_permissions_in_courses">[docs]</a>    <span class="k">def</span> <span class="nf">get_permissions_in_courses</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">wanted_perms</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Check for specific :class:`Permission`s in all courses</span>
<span class="sd">        (:class:`Course`) the user is enrolled in.</span>

<span class="sd">        Please note that passing an empty ``perms`` object is</span>
<span class="sd">        supported. However the resulting mapping will be empty.</span>

<span class="sd">        &gt;&gt;&gt; User().get_permissions_in_courses([])</span>
<span class="sd">        {}</span>

<span class="sd">        :param wanted_perms: The permissions names to check for.</span>
<span class="sd">        :returns: A mapping where the first keys indicate the course id,</span>
<span class="sd">            the values at this are a mapping between the given permission names</span>
<span class="sd">            and a boolean indicating if the current user has this permission</span>
<span class="sd">            for the course with this course id.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">wanted_perms</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>

        <span class="n">perms</span> <span class="o">=</span> <span class="n">psef</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">filter_all_or_404</span><span class="p">(</span>
            <span class="n">Permission</span><span class="p">,</span>
            <span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">DbColumn</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">Permission</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">wanted_perms</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">course_roles</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">user_course</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">course_id</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">User</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">user_course</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">user_id</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">subquery</span><span class="p">(</span><span class="s1">&#39;course_roles&#39;</span><span class="p">)</span>

        <span class="n">crp</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="n">course_permissions</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">course_role_id</span><span class="p">,</span>
            <span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">DbColumn</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">Permission</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">Permission</span><span class="p">,</span>
            <span class="n">course_permissions</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">permission_id</span> <span class="o">==</span> <span class="n">Permission</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">DbColumn</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">Permission</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">perms</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">subquery</span><span class="p">(</span><span class="s1">&#39;crp&#39;</span><span class="p">)</span>

        <span class="n">res</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">course_roles</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">course_id</span><span class="p">,</span> <span class="n">crp</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">crp</span><span class="p">,</span>
            <span class="n">course_roles</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">course_id</span> <span class="o">==</span> <span class="n">crp</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">course_role_id</span><span class="p">,</span>
            <span class="n">isouter</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="n">lookup</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Set</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">course_role_id</span><span class="p">,</span> <span class="n">permission_id</span> <span class="ow">in</span> <span class="n">res</span><span class="p">:</span>
            <span class="n">lookup</span><span class="p">[</span><span class="n">permission_id</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">course_role_id</span><span class="p">)</span>

        <span class="n">out</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">MutableMapping</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">course_id</span><span class="p">,</span> <span class="n">course_role</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">courses</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">out</span><span class="p">[</span><span class="n">course_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
                <span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="p">(</span><span class="n">course_role</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="n">lookup</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">id</span><span class="p">])</span> <span class="o">!=</span> <span class="n">p</span><span class="o">.</span><span class="n">default_value</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">perms</span>
            <span class="p">}</span>

        <span class="k">return</span> <span class="n">out</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">can_see_hidden</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Can the user see hidden assignments.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_course_permission_once</span><span class="p">(</span><span class="s1">&#39;can_see_hidden_assignments&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="User.__to_json__"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.User.__to_json__">[docs]</a>    <span class="k">def</span> <span class="nf">__to_json__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Creates a JSON serializable representation of this object.</span>

<span class="sd">        This object will look like this:</span>

<span class="sd">        .. code:: python</span>

<span class="sd">            {</span>
<span class="sd">                &#39;id&#39;:    int, # The id of this user.</span>
<span class="sd">                &#39;name&#39;:  str, # The full name of this user.</span>
<span class="sd">                &#39;email&#39;: str, # The email of this user.</span>
<span class="sd">                &#39;username&#39;: str, # The username of this user.</span>
<span class="sd">            }</span>

<span class="sd">        :returns: An object as described above.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;email&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="p">,</span>
            <span class="s1">&#39;username&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="User.__extended_to_json__"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.User.__extended_to_json__">[docs]</a>    <span class="k">def</span> <span class="nf">__extended_to_json__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Create a extended JSON serializable representation of this object.</span>

<span class="sd">        This object will look like this:</span>

<span class="sd">        .. code:: python</span>

<span class="sd">            {</span>
<span class="sd">                &#39;hidden&#39;: bool, # indicating if this user can once</span>
<span class="sd">                                # see hidden assignments.</span>
<span class="sd">                **self.__to_json__()</span>
<span class="sd">            }</span>

<span class="sd">        :returns: A object as described above.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;hidden&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">can_see_hidden</span><span class="p">,</span>
            <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">__to_json__</span><span class="p">(),</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="User.has_course_permission_once"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.User.has_course_permission_once">[docs]</a>    <span class="k">def</span> <span class="nf">has_course_permission_once</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                   <span class="n">perm</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Permission</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check whether this user has the specified course :class:`Permission`</span>
<span class="sd">        in at least one enrolled :class:`Course`.</span>

<span class="sd">        :param perm: The permission or permission name</span>
<span class="sd">        :returns: True if the user has the permission once</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">permission</span><span class="p">:</span> <span class="n">Permission</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">perm</span><span class="p">,</span> <span class="n">Permission</span><span class="p">):</span>
            <span class="n">permission</span> <span class="o">=</span> <span class="n">perm</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">permission</span> <span class="o">=</span> <span class="n">Permission</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
                <span class="n">name</span><span class="o">=</span><span class="n">perm</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">assert</span> <span class="n">permission</span><span class="o">.</span><span class="n">course_permission</span>

        <span class="n">course_roles</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">user_course</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">course_id</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">User</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">user_course</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">user_id</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">subquery</span><span class="p">(</span><span class="s1">&#39;course_roles&#39;</span><span class="p">)</span>
        <span class="n">crp</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">course_permissions</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">course_role_id</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">Permission</span><span class="p">,</span> <span class="n">course_permissions</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">permission_id</span> <span class="o">==</span> <span class="n">Permission</span><span class="o">.</span><span class="n">id</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Permission</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">permission</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">subquery</span><span class="p">(</span><span class="s1">&#39;crp&#39;</span><span class="p">)</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">course_roles</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">course_id</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">crp</span><span class="p">,</span> <span class="n">course_roles</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">course_id</span> <span class="o">==</span> <span class="n">crp</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">course_role_id</span>
        <span class="p">)</span>
        <span class="n">link</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">exists</span><span class="p">())</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span>

        <span class="k">return</span> <span class="p">(</span><span class="ow">not</span> <span class="n">link</span><span class="p">)</span> <span class="k">if</span> <span class="n">permission</span><span class="o">.</span><span class="n">default_value</span> <span class="k">else</span> <span class="n">link</span></div>

<div class="viewcode-block" id="User.get_all_permissions"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.User.get_all_permissions">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_permissions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">course_id</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="s1">&#39;Course&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get all global permissions (:class:`Permission`) of this user or all</span>
<span class="sd">        course permissions of the user in a specific :class:`Course`.</span>

<span class="sd">        :param course_id: The course or course id</span>

<span class="sd">        :returns: A name boolean mapping where the name is the name of the</span>
<span class="sd">                  permission and the value indicates if this user has this</span>
<span class="sd">                  permission.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">course_id</span><span class="p">,</span> <span class="n">Course</span><span class="p">):</span>
            <span class="n">course_id</span> <span class="o">=</span> <span class="n">course_id</span><span class="o">.</span><span class="n">id</span>

        <span class="k">if</span> <span class="n">course_id</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">role</span><span class="o">.</span><span class="n">get_all_permissions</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">course_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">courses</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">courses</span><span class="p">[</span><span class="n">course_id</span><span class="p">]</span><span class="o">.</span><span class="n">get_all_permissions</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">perms</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Permission</span><span class="p">]</span>
            <span class="n">perms</span> <span class="o">=</span> <span class="n">Permission</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
                <span class="n">course_permission</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">perm</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="kc">False</span> <span class="k">for</span> <span class="n">perm</span> <span class="ow">in</span> <span class="n">perms</span><span class="p">}</span></div>

<div class="viewcode-block" id="User.get_reset_token"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.User.get_reset_token">[docs]</a>    <span class="k">def</span> <span class="nf">get_reset_token</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get a token which a user can use to reset his password.</span>

<span class="sd">        :returns: A token that can be used in :py:meth:`User.reset_password` to</span>
<span class="sd">            reset the password of a user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">timed_serializer</span> <span class="o">=</span> <span class="n">URLSafeTimedSerializer</span><span class="p">(</span>
            <span class="n">psef</span><span class="o">.</span><span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SECRET_KEY&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_token</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="k">return</span> <span class="nb">str</span><span class="p">(</span>
            <span class="n">timed_serializer</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">username</span><span class="p">,</span> <span class="n">salt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reset_token</span><span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="User.reset_password"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.User.reset_password">[docs]</a>    <span class="k">def</span> <span class="nf">reset_password</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new_password</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Reset a users password by using a token.</span>

<span class="sd">        .. note:: Don&#39;t forget to commit the database.</span>

<span class="sd">        :param token: A token as generated by :py:meth:`User.get_reset_token`.</span>
<span class="sd">        :param new_password: The new password to set.</span>
<span class="sd">        :returns: Nothing.</span>

<span class="sd">        :raises psef.auth.PermissionException: If something was wrong with the</span>
<span class="sd">            given token.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">timed_serializer</span> <span class="o">=</span> <span class="n">URLSafeTimedSerializer</span><span class="p">(</span>
            <span class="n">psef</span><span class="o">.</span><span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;SECRET_KEY&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">username</span> <span class="o">=</span> <span class="n">timed_serializer</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span>
                <span class="n">token</span><span class="p">,</span>
                <span class="n">max_age</span><span class="o">=</span><span class="n">psef</span><span class="o">.</span><span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;RESET_TOKEN_TIME&#39;</span><span class="p">],</span>
                <span class="n">salt</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reset_token</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">BadSignature</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">traceback</span>
            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
            <span class="k">raise</span> <span class="n">psef</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">PermissionException</span><span class="p">(</span>
                <span class="s1">&#39;The given token is not valid&#39;</span><span class="p">,</span>
                <span class="n">f</span><span class="s1">&#39;The given token </span><span class="si">{token}</span><span class="s1"> is not valid.&#39;</span><span class="p">,</span>
                <span class="n">psef</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">APICodes</span><span class="o">.</span><span class="n">INVALID_CREDENTIALS</span><span class="p">,</span> <span class="mi">403</span>
            <span class="p">)</span>

        <span class="c1"># This should never happen but better safe than sorry.</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">username</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">username</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">reset_token</span> <span class="ow">is</span> <span class="kc">None</span>
        <span class="p">):</span>  <span class="c1"># pragma: no cover</span>
            <span class="k">raise</span> <span class="n">psef</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">PermissionException</span><span class="p">(</span>
                <span class="s1">&#39;The given token is not valid for this user&#39;</span><span class="p">,</span>
                <span class="n">f</span><span class="s1">&#39;The given token </span><span class="si">{token}</span><span class="s1"> is not valid for user &quot;</span><span class="si">{self.id}</span><span class="s1">&quot;.&#39;</span><span class="p">,</span>
                <span class="n">psef</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">APICodes</span><span class="o">.</span><span class="n">INVALID_CREDENTIALS</span><span class="p">,</span> <span class="mi">403</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="n">new_password</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_token</span> <span class="o">=</span> <span class="kc">None</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_active</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Is the current user an active user.</span>

<span class="sd">        .. todo::</span>

<span class="sd">            Remove this property</span>

<span class="sd">        :returns: If the user is active.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">active</span></div>


<div class="viewcode-block" id="Course"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.Course">[docs]</a><span class="k">class</span> <span class="nc">Course</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class describes a course.</span>

<span class="sd">    A course can hold a collection of :class:`Assignment` objects.</span>

<span class="sd">    :param name: The name of the course</span>
<span class="sd">    :param lti_course_id: The id of the course in LTI</span>
<span class="sd">    :param lti_provider: The LTI provider</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">query</span>  <span class="c1"># type: t.ClassVar[_MyQuery[&#39;Course&#39;]]</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;Course&quot;</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">)</span>

    <span class="n">created_at</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span>
    <span class="p">)</span>

    <span class="c1"># All stuff for LTI</span>
    <span class="n">lti_course_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">lti_provider_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">UUID_LENGTH</span><span class="p">),</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;LTIProvider.id&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">lti_provider</span><span class="p">:</span> <span class="n">LTIProvider</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;LTIProvider&quot;</span><span class="p">)</span>

    <span class="n">assignments</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;Assignment&quot;</span><span class="p">,</span> <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;course&quot;</span><span class="p">,</span> <span class="n">cascade</span><span class="o">=</span><span class="s1">&#39;all,delete&#39;</span>
    <span class="p">)</span>  <span class="c1"># type: t.MutableSequence[Assignment]</span>

<div class="viewcode-block" id="Course.__init__"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.Course.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">lti_course_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">lti_provider</span><span class="p">:</span> <span class="n">LTIProvider</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
            <span class="n">lti_course_id</span><span class="o">=</span><span class="n">lti_course_id</span><span class="p">,</span>
            <span class="n">lti_provider</span><span class="o">=</span><span class="n">lti_provider</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">role_name</span><span class="p">,</span> <span class="n">perms</span> <span class="ow">in</span> <span class="n">CourseRole</span><span class="o">.</span><span class="n">get_default_course_roles</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">CourseRole</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">role_name</span><span class="p">,</span> <span class="n">course</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">_permissions</span><span class="o">=</span><span class="n">perms</span><span class="p">)</span></div>

<div class="viewcode-block" id="Course.__to_json__"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.Course.__to_json__">[docs]</a>    <span class="k">def</span> <span class="nf">__to_json__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Creates a JSON serializable representation of this object.</span>

<span class="sd">        This object will look like this:</span>

<span class="sd">        .. code:: python</span>

<span class="sd">            {</span>
<span class="sd">                &#39;name&#39;: str, # The name of the course,</span>
<span class="sd">                &#39;id&#39;: int, # The id of this course.</span>
<span class="sd">                &#39;created_at&#39;: str, # ISO UTC date.</span>
<span class="sd">                &#39;is_lti&#39;: bool, # Is the this course a LTI course,</span>
<span class="sd">            }</span>

<span class="sd">        :returns: A object as described above.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">created_at</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;is_lti&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lti_course_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="Course.get_all_visible_assignments"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.Course.get_all_visible_assignments">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_visible_assignments</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="s1">&#39;Assignment&#39;</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get all visible assignments for the current user for this course.</span>

<span class="sd">        :returns: A list of assignments the currently logged in user may see.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">psef</span><span class="o">.</span><span class="n">current_user</span><span class="o">.</span><span class="n">has_permission</span><span class="p">(</span>
            <span class="s1">&#39;can_see_hidden_assignments&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assignments</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">deadline</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span>
                <span class="p">(</span><span class="n">a</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignments</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">is_hidden</span><span class="p">),</span>
                <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">item</span><span class="p">:</span> <span class="n">item</span><span class="o">.</span><span class="n">deadline</span>
            <span class="p">)</span></div></div>


<div class="viewcode-block" id="GradeHistory"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.GradeHistory">[docs]</a><span class="k">class</span> <span class="nc">GradeHistory</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This object is a item in a grade history of a :class:`Work`.</span>

<span class="sd">    :ivar changed_at: When was this grade added.</span>
<span class="sd">    :ivar is_rubric: Was this grade added as a result of a rubric.</span>
<span class="sd">    :ivar passed_back: Was this grade passed back to the LMS through LTI.</span>
<span class="sd">    :ivar work: What work does this grade belong to.</span>
<span class="sd">    :ivar user: What user added this grade.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">query</span>  <span class="c1"># type: t.ClassVar[_MyQuery[&#39;GradeHistory&#39;]]</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;GradeHistory&quot;</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">changed_at</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span>
    <span class="p">)</span>
    <span class="n">is_rubric</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;is_rubric&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">)</span>
    <span class="n">grade</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;grade&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Float</span><span class="p">)</span>
    <span class="n">passed_back</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;passed_back&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="n">work_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;Work_id&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Work.id&#39;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;CASCADE&#39;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;User_id&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;User.id&#39;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;CASCADE&#39;</span><span class="p">),</span>
    <span class="p">)</span>

    <span class="n">work</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span><span class="s1">&#39;Work&#39;</span><span class="p">,</span> <span class="n">foreign_keys</span><span class="o">=</span><span class="n">work_id</span><span class="p">)</span>  <span class="c1"># type: &#39;Work&#39;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span><span class="s1">&#39;User&#39;</span><span class="p">,</span> <span class="n">foreign_keys</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>  <span class="c1"># type: User</span>

<div class="viewcode-block" id="GradeHistory.__to_json__"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.GradeHistory.__to_json__">[docs]</a>    <span class="k">def</span> <span class="nf">__to_json__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Converts a rubric of a work to a object that is JSON serializable.</span>

<span class="sd">        The resulting object will look like this:</span>

<span class="sd">        .. code:: python</span>

<span class="sd">            {</span>
<span class="sd">                &#39;changed_at&#39;: str, # The date the history was added.</span>
<span class="sd">                &#39;is_rubric&#39;: bool, # Was this history items added by a rubric</span>
<span class="sd">                                   # grade.</span>
<span class="sd">                &#39;grade&#39;: float, # The new grade, -1 if the grade was deleted.</span>
<span class="sd">                &#39;passed_back&#39;: bool, # Is this grade given back to LTI.</span>
<span class="sd">                &#39;user&#39;: User, # The user that added this grade.</span>
<span class="sd">            }</span>

<span class="sd">        :returns: A object as described above.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;changed_at&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">changed_at</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;is_rubric&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_rubric</span><span class="p">,</span>
            <span class="s1">&#39;grade&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">grade</span><span class="p">,</span>
            <span class="s1">&#39;passed_back&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">passed_back</span><span class="p">,</span>
            <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
        <span class="p">}</span></div></div>


<div class="viewcode-block" id="Work"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.Work">[docs]</a><span class="k">class</span> <span class="nc">Work</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This object describes a single work or submission of a :class:`User` for</span>
<span class="sd">    an :class:`Assignment`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">query</span>  <span class="c1"># type: t.ClassVar[_MyQuery[&#39;Work&#39;]]</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;Work&quot;</span>  <span class="c1"># type: str</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>  <span class="c1"># type: int</span>
    <span class="n">assignment_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;Assignment_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Assignment.id&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;User_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;User.id&#39;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;CASCADE&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">_grade</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;grade&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="n">comment</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">orm</span><span class="o">.</span><span class="n">deferred</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span>
    <span class="p">)</span>
    <span class="n">assigned_to</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;assigned_to&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;User.id&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">selected_items</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="s1">&#39;RubricItem&#39;</span><span class="p">,</span> <span class="n">secondary</span><span class="o">=</span><span class="n">work_rubric_item</span>
    <span class="p">)</span>  <span class="c1"># type: t.MutableSequence[&#39;RubricItem&#39;]</span>

    <span class="n">assignment</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="s1">&#39;Assignment&#39;</span><span class="p">,</span> <span class="n">foreign_keys</span><span class="o">=</span><span class="n">assignment_id</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;joined&#39;</span>
    <span class="p">)</span>  <span class="c1"># type: &#39;Assignment&#39;</span>
    <span class="n">user</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="s1">&#39;User&#39;</span><span class="p">,</span> <span class="n">foreign_keys</span><span class="o">=</span><span class="n">user_id</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;joined&#39;</span>
    <span class="p">)</span>  <span class="c1"># type: User</span>
    <span class="n">assignee</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="s1">&#39;User&#39;</span><span class="p">,</span> <span class="n">foreign_keys</span><span class="o">=</span><span class="n">assigned_to</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;joined&#39;</span>
    <span class="p">)</span>  <span class="c1"># type: User</span>

<div class="viewcode-block" id="Work.divide_new_work"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.Work.divide_new_work">[docs]</a>    <span class="k">def</span> <span class="nf">divide_new_work</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Divide a freshly created work.</span>

<span class="sd">        First we check if an old work of the same author exists, that case the</span>
<span class="sd">        same grader is assigned. Otherwise we take the grader that misses the</span>
<span class="sd">        most of work.</span>

<span class="sd">        :returns: Nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assigned_to</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment</span><span class="o">.</span><span class="n">get_from_latest_submissions</span><span class="p">(</span>
            <span class="n">Work</span><span class="o">.</span><span class="n">assigned_to</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Work</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">assigned_to</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">missing</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment</span><span class="o">.</span><span class="n">get_divided_amount_missing</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assigned_to</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">missing</span><span class="o">.</span><span class="n">keys</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">missing</span><span class="o">.</span><span class="n">get</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assignment</span><span class="o">.</span><span class="n">set_graders_to_not_done</span><span class="p">(</span>
                    <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">assigned_to</span><span class="p">],</span>
                    <span class="n">send_mail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span></div>

<div class="viewcode-block" id="Work.run_linter"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.Work.run_linter">[docs]</a>    <span class="k">def</span> <span class="nf">run_linter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Run all linters for the assignment on this work.</span>

<span class="sd">        All linters that have been used on the assignment will also run on this</span>
<span class="sd">        work.</span>

<span class="sd">        If the linters feature is disabled this function will simply return and</span>
<span class="sd">        not do anything.</span>

<span class="sd">        :returns: Nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">psef</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">has_feature</span><span class="p">(</span><span class="s1">&#39;LINTERS&#39;</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="k">for</span> <span class="n">linter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment</span><span class="o">.</span><span class="n">linters</span><span class="p">:</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="n">LinterInstance</span><span class="p">(</span><span class="n">work</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">tester</span><span class="o">=</span><span class="n">linter</span><span class="p">)</span>

            <span class="n">linter_cls</span> <span class="o">=</span> <span class="n">psef</span><span class="o">.</span><span class="n">linters</span><span class="o">.</span><span class="n">get_linter_by_name</span><span class="p">(</span><span class="n">linter</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">linter_cls</span><span class="o">.</span><span class="n">RUN_LINTER</span><span class="p">:</span>
                <span class="n">instance</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">LinterState</span><span class="o">.</span><span class="n">done</span>

            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">linter_cls</span><span class="o">.</span><span class="n">RUN_LINTER</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="n">psef</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">lint_instances</span><span class="p">(</span>
                <span class="n">linter</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="n">linter</span><span class="o">.</span><span class="n">config</span><span class="p">,</span>
                <span class="p">[</span><span class="n">instance</span><span class="o">.</span><span class="n">id</span><span class="p">],</span>
            <span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">grade</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the actual current grade for this work.</span>

<span class="sd">        This is done by not only checking the ``grade`` field but also checking</span>
<span class="sd">        if rubric could be found.</span>

<span class="sd">        :returns: The current grade for this work.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grade</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_items</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="n">max_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment</span><span class="o">.</span><span class="n">max_rubric_points</span>
            <span class="n">selected</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">points</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_items</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">psef</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">between</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">selected</span> <span class="o">/</span> <span class="n">max_points</span> <span class="o">*</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_grade</span>

<div class="viewcode-block" id="Work.set_grade"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.Work.set_grade">[docs]</a>    <span class="k">def</span> <span class="nf">set_grade</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">new_grade</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
        <span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">,</span>
        <span class="n">add_to_session</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
        <span class="n">never_passback</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">GradeHistory</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set the grade to the new grade.</span>

<span class="sd">        .. note:: This also passes back the grade to LTI if this is necessary</span>
<span class="sd">            (see :py:func:`passback_grade`).</span>

<span class="sd">        :param new_grade: The new grade to set</span>
<span class="sd">        :param user: The user setting the new grade.</span>
<span class="sd">        :param add_to_session: Add the newly created history file to the</span>
<span class="sd">            current session.</span>
<span class="sd">        :param never_passback: Never passback the new grade.</span>
<span class="sd">        :returns: Nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_grade</span> <span class="o">=</span> <span class="n">new_grade</span>
        <span class="n">passback</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment</span><span class="o">.</span><span class="n">should_passback</span>
        <span class="n">grade</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grade</span>
        <span class="n">history</span> <span class="o">=</span> <span class="n">GradeHistory</span><span class="p">(</span>
            <span class="n">is_rubric</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_grade</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">grade</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
            <span class="n">grade</span><span class="o">=-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">grade</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">grade</span><span class="p">,</span>
            <span class="n">passed_back</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">work</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
            <span class="n">user</span><span class="o">=</span><span class="n">user</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">add_to_session</span><span class="p">:</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">history</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">never_passback</span> <span class="ow">and</span> <span class="n">passback</span><span class="p">:</span>
            <span class="n">psef</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">callback_after_this_request</span><span class="p">(</span>
                <span class="k">lambda</span><span class="p">:</span> <span class="n">psef</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">passback_grades</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">])</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">history</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">selected_rubric_points</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">float</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The amount of points that are currently selected in the rubric for</span>
<span class="sd">        this work.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">points</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_items</span><span class="p">)</span>

<div class="viewcode-block" id="Work.passback_grade"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.Work.passback_grade">[docs]</a>    <span class="k">def</span> <span class="nf">passback_grade</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Initiates a passback of the grade to the LTI consumer via the</span>
<span class="sd">        :class:`LTIProvider`.</span>

<span class="sd">        :param initial: Should we do a initial LTI grade passback with no</span>
<span class="sd">            result so that the real grade won&#39;t show as too late.</span>
<span class="sd">        :returns: Nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment</span><span class="o">.</span><span class="n">lti_outcome_service_url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">lti_provider</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment</span><span class="o">.</span><span class="n">course</span><span class="o">.</span><span class="n">lti_provider</span>
            <span class="k">if</span> <span class="n">initial</span><span class="p">:</span>
                <span class="n">url</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">/&#39;</span>
                    <span class="s1">&#39;courses/</span><span class="si">{}</span><span class="s1">/assignments/</span><span class="si">{}</span><span class="s1">/submissions?inLTI=true&#39;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;EXTERNAL_URL&#39;</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assignment</span><span class="o">.</span><span class="n">course_id</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assignment_id</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">url</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">psef</span><span class="o">.</span><span class="n">lti</span><span class="o">.</span><span class="n">LTI</span><span class="o">.</span><span class="n">passback_grade</span><span class="p">(</span>
                <span class="n">lti_provider</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
                <span class="n">lti_provider</span><span class="o">.</span><span class="n">secret</span><span class="p">,</span>
                <span class="kc">False</span> <span class="k">if</span> <span class="n">initial</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">grade</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assignment</span><span class="o">.</span><span class="n">lti_outcome_service_url</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">assignment</span><span class="o">.</span><span class="n">assignment_results</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">user_id</span><span class="p">]</span><span class="o">.</span><span class="n">sourcedid</span><span class="p">,</span>
                <span class="n">url</span><span class="o">=</span><span class="n">url</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">newest_grade_history_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">DbColumn</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">GradeHistory</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">work_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
                <span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">DbColumn</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">],</span>
                       <span class="n">GradeHistory</span><span class="o">.</span><span class="n">changed_at</span><span class="p">)</span><span class="o">.</span><span class="n">desc</span><span class="p">(),</span>
            <span class="p">)</span><span class="o">.</span><span class="n">limit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">with_for_update</span><span class="p">()</span>

            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">GradeHistory</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">GradeHistory</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">newest_grade_history_id</span><span class="o">.</span><span class="n">as_scalar</span><span class="p">(),</span>
            <span class="p">)</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
                <span class="p">{</span>
                    <span class="s1">&#39;passed_back&#39;</span><span class="p">:</span> <span class="kc">True</span>
                <span class="p">},</span> <span class="n">synchronize_session</span><span class="o">=</span><span class="s1">&#39;fetch&#39;</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="Work.select_rubric_items"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.Work.select_rubric_items">[docs]</a>    <span class="k">def</span> <span class="nf">select_rubric_items</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">items</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="s1">&#39;RubricItem&#39;</span><span class="p">],</span> <span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">,</span> <span class="n">override</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot; Selects the given :class:`RubricItem`.</span>

<span class="sd">        .. note:: This also passes back the grade to LTI if this is necessary.</span>

<span class="sd">        .. note:: This also sets the actual grade field to `None`.</span>

<span class="sd">        :param item: The item to add.</span>
<span class="sd">        :param user: The user selecting the item.</span>
<span class="sd">        :returns: Nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">override</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">selected_items</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">selected_items</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_grade</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">user</span><span class="p">)</span></div>

<div class="viewcode-block" id="Work.__to_json__"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.Work.__to_json__">[docs]</a>    <span class="k">def</span> <span class="nf">__to_json__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">MutableMapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Returns the JSON serializable representation of this work.</span>

<span class="sd">        The representation is based on the permissions (:class:`Permission`) of</span>
<span class="sd">        the logged in :class:`User`. Namely the assignee, feedback, and grade</span>
<span class="sd">        attributes are only included if the current user can see them,</span>
<span class="sd">        otherwise they are set to `None`.</span>

<span class="sd">        The resulting object will look like this:</span>

<span class="sd">        .. code:: python</span>

<span class="sd">            {</span>
<span class="sd">                &#39;id&#39;: int # Submission id.</span>
<span class="sd">                &#39;user&#39;: User # User that submitted this work.</span>
<span class="sd">                &#39;created_at&#39;: str # Submission date in ISO-8601 datetime</span>
<span class="sd">                                  # format.</span>
<span class="sd">                &#39;grade&#39;: t.Optional[float] # Grade for this submission, or</span>
<span class="sd">                                              # None if the submission hasn&#39;t</span>
<span class="sd">                                              # been graded yet or if the</span>
<span class="sd">                                              # logged in user doesn&#39;t have</span>
<span class="sd">                                              # permission to see the grade.</span>
<span class="sd">                &#39;assignee&#39;: t.Optional[User] # User assigned to grade this</span>
<span class="sd">                                                # submission, or None if the</span>
<span class="sd">                                                # logged in user doesn&#39;t have</span>
<span class="sd">                                                # permission to see the</span>
<span class="sd">                                                # assignee.</span>
<span class="sd">            }</span>

<span class="sd">        :returns: A dict containing JSON serializable representations of the</span>
<span class="sd">                  attributes of this work.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">item</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="p">,</span>
            <span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">created_at</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
        <span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">psef</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">ensure_permission</span><span class="p">(</span>
                <span class="s1">&#39;can_see_assignee&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment</span><span class="o">.</span><span class="n">course_id</span>
            <span class="p">)</span>
            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;assignee&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignee</span>
        <span class="k">except</span> <span class="n">psef</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">PermissionException</span><span class="p">:</span>
            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;assignee&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">psef</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">ensure_can_see_grade</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">psef</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">PermissionException</span><span class="p">:</span>
            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;grade&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">item</span><span class="p">[</span><span class="s1">&#39;grade&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grade</span>
        <span class="k">return</span> <span class="n">item</span></div>

<div class="viewcode-block" id="Work.__extended_to_json__"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.Work.__extended_to_json__">[docs]</a>    <span class="k">def</span> <span class="nf">__extended_to_json__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Create a extended JSON serializable representation of this object.</span>

<span class="sd">        This object will look like this:</span>

<span class="sd">        .. code:: python</span>

<span class="sd">            {</span>
<span class="sd">                &#39;comment&#39;: t.Optional[str] # General feedback comment for</span>
<span class="sd">                                           # this submission, or None in</span>
<span class="sd">                                           # the same cases as the grade.</span>
<span class="sd">                **self.__to_json__()</span>
<span class="sd">            }</span>

<span class="sd">        :returns: A object as described above.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__to_json__</span><span class="p">()</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">psef</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">ensure_can_see_grade</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">psef</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">PermissionException</span><span class="p">:</span>
            <span class="n">res</span><span class="p">[</span><span class="s1">&#39;comment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span><span class="p">[</span><span class="s1">&#39;comment&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">comment</span>

        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="Work.__rubric_to_json__"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.Work.__rubric_to_json__">[docs]</a>    <span class="k">def</span> <span class="nf">__rubric_to_json__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Converts a rubric of a work to a object that is JSON serializable.</span>

<span class="sd">        The resulting object will look like this:</span>

<span class="sd">        .. code:: python</span>

<span class="sd">            {</span>
<span class="sd">                &#39;rubrics&#39;: t.List[RubricRow] # A list of all the rubrics for</span>
<span class="sd">                                             # this work.</span>
<span class="sd">                &#39;selected&#39;: t.List[RubricItem] # A list of all the selected</span>
<span class="sd">                                               # rubric items for this work,</span>
<span class="sd">                                               # or an empty list if the logged</span>
<span class="sd">                                               # in user doesn&#39;t have</span>
<span class="sd">                                               # permission to see the rubric.</span>
<span class="sd">                &#39;points&#39;: {</span>
<span class="sd">                    &#39;max&#39;: t.Optional[float] # The maximal amount of points</span>
<span class="sd">                                                # for this rubric, or `None` if</span>
<span class="sd">                                                # logged in user doesn&#39;t have</span>
<span class="sd">                                                # permission to see the rubric.</span>
<span class="sd">                    &#39;selected&#39;: t.Optional[float] # The amount of point that</span>
<span class="sd">                                                     # is selected for this</span>
<span class="sd">                                                     # work, or `None` if the</span>
<span class="sd">                                                     # logged in user doesn&#39;t</span>
<span class="sd">                                                     # have permission to see</span>
<span class="sd">                                                     # the rubric.</span>
<span class="sd">                }</span>
<span class="sd">            }</span>

<span class="sd">        :returns: A object as described above.</span>

<span class="sd">        .. todo:: Remove the points object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">psef</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">ensure_can_see_grade</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;rubrics&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment</span><span class="o">.</span><span class="n">rubric_rows</span><span class="p">,</span>
                <span class="s1">&#39;selected&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_items</span><span class="p">,</span>
                <span class="s1">&#39;points&#39;</span><span class="p">:</span>
                    <span class="p">{</span>
                        <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment</span><span class="o">.</span><span class="n">max_rubric_points</span><span class="p">,</span>
                        <span class="s1">&#39;selected&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">selected_rubric_points</span><span class="p">,</span>
                    <span class="p">},</span>
            <span class="p">}</span>
        <span class="k">except</span> <span class="n">psef</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">PermissionException</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s1">&#39;rubrics&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">assignment</span><span class="o">.</span><span class="n">rubric_rows</span><span class="p">,</span>
                <span class="s1">&#39;selected&#39;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s1">&#39;points&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;max&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="s1">&#39;selected&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
                <span class="p">},</span>
            <span class="p">}</span></div>

<div class="viewcode-block" id="Work.add_file_tree"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.Work.add_file_tree">[docs]</a>    <span class="k">def</span> <span class="nf">add_file_tree</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">session</span><span class="p">:</span> <span class="s1">&#39;orm.scoped_session&#39;</span><span class="p">,</span> <span class="n">tree</span><span class="p">:</span> <span class="s1">&#39;psef.files.ExtractFileTree&#39;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add the given tree to given session.</span>

<span class="sd">        .. warning::</span>

<span class="sd">            The db session is not commited!</span>

<span class="sd">        :param session: The db session</span>
<span class="sd">        :param tree: The file tree as described by</span>
<span class="sd">            :py:func:`psef.files.rename_directory_structure`</span>
<span class="sd">        :returns: Nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_file_tree</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">tree</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_add_file_tree</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">session</span><span class="p">:</span> <span class="s1">&#39;orm.scoped_session&#39;</span><span class="p">,</span>
        <span class="n">tree</span><span class="p">:</span> <span class="s1">&#39;psef.files.ExtractFileTree&#39;</span><span class="p">,</span>
        <span class="n">top</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="s1">&#39;File&#39;</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Add the given tree to the session with top as parent.</span>

<span class="sd">        :param session: The db session</span>
<span class="sd">        :param tree: The file tree as described by</span>
<span class="sd">                          :py:func:`psef.files.rename_directory_structure`</span>
<span class="sd">        :param top: The parent file</span>
<span class="sd">        :returns: Nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">old_top</span><span class="p">,</span> <span class="n">children</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">new_top</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span>
                <span class="n">work</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_directory</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">old_top</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="n">top</span>
            <span class="p">)</span>
            <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">new_top</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">MutableMapping</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_add_file_tree</span><span class="p">(</span><span class="n">session</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">new_top</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="n">child</span>
                <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                    <span class="n">File</span><span class="p">(</span>
                        <span class="n">work</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
                        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                        <span class="n">filename</span><span class="o">=</span><span class="n">filename</span><span class="p">,</span>
                        <span class="n">is_directory</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">parent</span><span class="o">=</span><span class="n">new_top</span>
                    <span class="p">)</span>
                <span class="p">)</span>

<div class="viewcode-block" id="Work.get_all_feedback"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.Work.get_all_feedback">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_feedback</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get all feedback for this work.</span>

<span class="sd">        :returns: A tuple of two iterators both producing human readable</span>
<span class="sd">            representations of the given feedback. The first iterator produces</span>
<span class="sd">            the feedback given by a person and the second the feedback given by</span>
<span class="sd">            the linters.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">def</span> <span class="nf">__get_user_feedback</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
            <span class="n">comments</span> <span class="o">=</span> <span class="n">Comment</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">DbColumn</span><span class="p">[</span><span class="n">File</span><span class="p">],</span> <span class="n">Comment</span><span class="o">.</span><span class="n">file</span><span class="p">)</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">work</span><span class="o">=</span><span class="bp">self</span><span class="p">),</span>
            <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
                <span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">DbColumn</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">Comment</span><span class="o">.</span><span class="n">file_id</span><span class="p">)</span><span class="o">.</span><span class="n">asc</span><span class="p">(),</span>
                <span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">DbColumn</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">Comment</span><span class="o">.</span><span class="n">line</span><span class="p">)</span><span class="o">.</span><span class="n">asc</span><span class="p">(),</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">com</span> <span class="ow">in</span> <span class="n">comments</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">f</span><span class="s1">&#39;</span><span class="si">{com.file.name}</span><span class="s1">:</span><span class="si">{com.line}</span><span class="s1">:0: </span><span class="si">{com.comment}</span><span class="s1">&#39;</span>

        <span class="k">def</span> <span class="nf">__get_linter_feedback</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
            <span class="n">linter_comments</span> <span class="o">=</span> <span class="n">LinterComment</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">LinterComment</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">work</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
            <span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span>
                <span class="n">LinterComment</span><span class="o">.</span><span class="n">file_id</span><span class="o">.</span><span class="n">asc</span><span class="p">(),</span>  <span class="c1"># type: ignore</span>
                <span class="n">LinterComment</span><span class="o">.</span><span class="n">line</span><span class="o">.</span><span class="n">asc</span><span class="p">(),</span>  <span class="c1"># type: ignore</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">line_comm</span> <span class="ow">in</span> <span class="n">linter_comments</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">(</span>
                    <span class="n">f</span><span class="s1">&#39;</span><span class="si">{line_comm.file.name}</span><span class="s1">:</span><span class="si">{line_comm.line}</span><span class="s1">:0: &#39;</span>
                    <span class="n">f</span><span class="s1">&#39;(</span><span class="si">{line_comm.linter.tester.name}</span><span class="s1">&#39;</span>
                    <span class="n">f</span><span class="s1">&#39; </span><span class="si">{line_comm.linter_code}</span><span class="s1">) </span><span class="si">{line_comm.comment}</span><span class="s1">&#39;</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">__get_user_feedback</span><span class="p">(),</span> <span class="n">__get_linter_feedback</span><span class="p">()</span></div>

<div class="viewcode-block" id="Work.remove_selected_rubric_item"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.Work.remove_selected_rubric_item">[docs]</a>    <span class="k">def</span> <span class="nf">remove_selected_rubric_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">row_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Deselect selected :class:`RubricItem` on row.</span>

<span class="sd">        Deselects the selected rubric item on the given row with _row_id_  (if</span>
<span class="sd">        there are any selected).</span>

<span class="sd">        :param row_id: The id of the RubricRow from which to deselect</span>
<span class="sd">                           rubric items</span>
<span class="sd">        :returns: Nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rubricitem</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">RubricItem</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">work_rubric_item</span><span class="p">,</span> <span class="n">RubricItem</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">work_rubric_item</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">rubricitem_id</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">work_rubric_item</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">work_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">RubricItem</span><span class="o">.</span><span class="n">rubricrow_id</span> <span class="o">==</span> <span class="n">row_id</span>
        <span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rubricitem</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">selected_items</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">rubricitem</span><span class="p">)</span></div>

<div class="viewcode-block" id="Work.search_file"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.Work.search_file">[docs]</a>    <span class="k">def</span> <span class="nf">search_file</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pathname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">exclude</span><span class="p">:</span> <span class="s1">&#39;FileOwner&#39;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;File&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Search for a file in the this directory with the given name.</span>

<span class="sd">        :param pathname: The path of the file to search for, this may contain</span>
<span class="sd">            leading and trailing slashes which do not have any meaning.</span>
<span class="sd">        :param exclude: The fileowner to exclude from search, like described in</span>
<span class="sd">            :func:`get_zip`.</span>
<span class="sd">        :returns: The found file.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">patharr</span><span class="p">,</span> <span class="n">is_dir</span> <span class="o">=</span> <span class="n">psef</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">split_path</span><span class="p">(</span><span class="n">pathname</span><span class="p">)</span>

        <span class="n">parent</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">pathpart</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">patharr</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
            <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span>

            <span class="n">parent</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">DbColumn</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">File</span><span class="o">.</span><span class="n">id</span><span class="p">))</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">File</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">pathpart</span><span class="p">,</span>
                <span class="n">File</span><span class="o">.</span><span class="n">parent_id</span> <span class="o">==</span> <span class="n">parent</span><span class="p">,</span>
                <span class="n">File</span><span class="o">.</span><span class="n">work_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="n">File</span><span class="o">.</span><span class="n">is_directory</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">subquery</span><span class="p">(</span><span class="n">f</span><span class="s1">&#39;parent_</span><span class="si">{idx}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">parent</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span>

        <span class="k">return</span> <span class="n">psef</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">filter_single_or_404</span><span class="p">(</span>
            <span class="n">File</span><span class="p">,</span>
            <span class="n">File</span><span class="o">.</span><span class="n">work_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">File</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">patharr</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
            <span class="n">File</span><span class="o">.</span><span class="n">parent_id</span> <span class="o">==</span> <span class="n">parent</span><span class="p">,</span>
            <span class="n">File</span><span class="o">.</span><span class="n">fileowner</span> <span class="o">!=</span> <span class="n">exclude</span><span class="p">,</span>
            <span class="n">File</span><span class="o">.</span><span class="n">is_directory</span> <span class="o">==</span> <span class="n">is_dir</span><span class="p">,</span>
        <span class="p">)</span></div></div>


<div class="viewcode-block" id="FileOwner"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.FileOwner">[docs]</a><span class="nd">@enum</span><span class="o">.</span><span class="n">unique</span>
<span class="k">class</span> <span class="nc">FileOwner</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Describes to which version of a submission (student&#39;s submission or</span>
<span class="sd">    teacher&#39;s revision) a file belongs. When a student adds or changes a file</span>
<span class="sd">    after the deadline for the assignment has passed, the original file&#39;s owner</span>
<span class="sd">    is set `teacher` and the new file&#39;s to `student`.</span>

<span class="sd">    :param student: The file is in the student&#39;s submission, but changed in the</span>
<span class="sd">        teacher&#39;s revision.</span>
<span class="sd">    :param teacher: The inverse of `student`. The file is added or changed in</span>
<span class="sd">        the teacher&#39;s revision.</span>
<span class="sd">    :param both: The file is not changed in the teacher&#39;s revision and belongs</span>
<span class="sd">        to both versions.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">student</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">teacher</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">both</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span></div>


<div class="viewcode-block" id="File"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.File">[docs]</a><span class="k">class</span> <span class="nc">File</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    This object describes a file or directory that stored is stored on the</span>
<span class="sd">    server.</span>

<span class="sd">    Files are always connected to :class:`Work` objects. A directory file does</span>
<span class="sd">    not physically exist but is stored only in the database to preserve the</span>
<span class="sd">    submitted work structure. Each submission should have a single top level</span>
<span class="sd">    file. Each other file in a submission should be directly or indirectly</span>
<span class="sd">    connected to this file via the parent attribute.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">query</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">ClassVar</span><span class="p">[</span><span class="n">_MyQuery</span><span class="p">[</span><span class="s1">&#39;File&#39;</span><span class="p">]]</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;File&quot;</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">work_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;Work_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Work.id&#39;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;CASCADE&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># This is the filename for the original file on the disk</span>
    <span class="n">filename</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
    <span class="n">filename</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;filename&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">modification_date</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;modification_date&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span>
    <span class="p">)</span>

    <span class="n">fileowner</span><span class="p">:</span> <span class="n">FileOwner</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;fileowner&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="n">FileOwner</span><span class="p">),</span>
        <span class="n">default</span><span class="o">=</span><span class="n">FileOwner</span><span class="o">.</span><span class="n">both</span><span class="p">,</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>

    <span class="n">is_directory</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;is_directory&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Boolean</span><span class="p">)</span>
    <span class="n">parent_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;parent_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;File.id&#39;</span><span class="p">))</span>

    <span class="c1"># This variable is generated from the backref from the parent</span>
    <span class="n">children</span><span class="p">:</span> <span class="s1">&#39;_MyQuery[&quot;File&quot;]&#39;</span>

    <span class="n">parent</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="s1">&#39;File&#39;</span><span class="p">,</span>
        <span class="n">remote_side</span><span class="o">=</span><span class="p">[</span><span class="nb">id</span><span class="p">],</span>
        <span class="n">backref</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">backref</span><span class="p">(</span><span class="s1">&#39;children&#39;</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;dynamic&#39;</span><span class="p">)</span>
    <span class="p">)</span>  <span class="c1"># type: &#39;File&#39;</span>

    <span class="n">work</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span><span class="s1">&#39;Work&#39;</span><span class="p">,</span> <span class="n">foreign_keys</span><span class="o">=</span><span class="n">work_id</span><span class="p">)</span>  <span class="c1"># type: &#39;Work&#39;</span>

<div class="viewcode-block" id="File.get_exclude_owner"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.File.get_exclude_owner">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_exclude_owner</span><span class="p">(</span><span class="n">owner</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">course_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FileOwner</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the :class:`FileOwner` the current user does not want to see</span>
<span class="sd">        files for.</span>

<span class="sd">        The result will be decided like this, if the given str is not</span>
<span class="sd">        `student`, `teacher` or `auto` the result will be `FileOwner.teacher`.</span>
<span class="sd">        If the str is `student`, the result will be `FileOwner.teacher`, vica</span>
<span class="sd">        versa for `teacher` as input. If the input is auto `student` will be</span>
<span class="sd">        returned if the currently logged in user is a teacher, otherwise it</span>
<span class="sd">        will be `student`.</span>

<span class="sd">        :param owner: The owner that was given in the `GET` paramater.</span>
<span class="sd">        :param course_id: The course for which the files are requested.</span>
<span class="sd">        :returns: The object determined as described above.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">psef</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">ensure_logged_in</span><span class="p">()</span>

        <span class="n">teacher</span><span class="p">,</span> <span class="n">student</span> <span class="o">=</span> <span class="n">FileOwner</span><span class="o">.</span><span class="n">teacher</span><span class="p">,</span> <span class="n">FileOwner</span><span class="o">.</span><span class="n">student</span>
        <span class="k">if</span> <span class="n">owner</span> <span class="o">==</span> <span class="s1">&#39;student&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">teacher</span>
        <span class="k">elif</span> <span class="n">owner</span> <span class="o">==</span> <span class="s1">&#39;teacher&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">student</span>
        <span class="k">elif</span> <span class="n">owner</span> <span class="o">==</span> <span class="s1">&#39;auto&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">psef</span><span class="o">.</span><span class="n">current_user</span><span class="o">.</span><span class="n">has_permission</span><span class="p">(</span>
                <span class="s1">&#39;can_edit_others_work&#39;</span><span class="p">,</span> <span class="n">course_id</span>
            <span class="p">):</span>
                <span class="k">return</span> <span class="n">student</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">teacher</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">teacher</span></div>

<div class="viewcode-block" id="File.get_diskname"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.File.get_diskname">[docs]</a>    <span class="k">def</span> <span class="nf">get_diskname</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the absolute path on the disk for this file.</span>

<span class="sd">        :returns: The absolute path.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">assert</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_directory</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_app</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;UPLOAD_DIR&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">filename</span><span class="p">)</span></div>

<div class="viewcode-block" id="File.delete_from_disk"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.File.delete_from_disk">[docs]</a>    <span class="k">def</span> <span class="nf">delete_from_disk</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Delete the file from disk if it is not a directory.</span>

<span class="sd">        :returns: Nothing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_directory</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_diskname</span><span class="p">())</span></div>

<div class="viewcode-block" id="File.list_contents"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.File.list_contents">[docs]</a>    <span class="k">def</span> <span class="nf">list_contents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exclude</span><span class="p">:</span> <span class="n">FileOwner</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;psef.files.FileTree&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;List the basic file info and the info of its children.</span>

<span class="sd">        If the file is a directory it will return a tree like this:</span>

<span class="sd">        .. code:: python</span>

<span class="sd">            {</span>
<span class="sd">                &#39;name&#39;: &#39;dir_1&#39;,</span>
<span class="sd">                &#39;id&#39;: 1,</span>
<span class="sd">                &#39;entries&#39;: [</span>
<span class="sd">                    {</span>
<span class="sd">                        &#39;name&#39;: &#39;file_1&#39;,</span>
<span class="sd">                        &#39;id&#39;: 2</span>
<span class="sd">                    },</span>
<span class="sd">                    {</span>
<span class="sd">                        &#39;name&#39;: &#39;file_2&#39;,</span>
<span class="sd">                        &#39;id&#39;: 3</span>
<span class="sd">                    },</span>
<span class="sd">                    {</span>
<span class="sd">                        &#39;name&#39;: &#39;dir_2&#39;,</span>
<span class="sd">                        &#39;id&#39;: 4,</span>
<span class="sd">                        &#39;entries&#39;: []</span>
<span class="sd">                    }</span>
<span class="sd">                ]</span>
<span class="sd">            }</span>

<span class="sd">        Otherwise it will formatted like one of the file children of the above</span>
<span class="sd">        tree.</span>

<span class="sd">        :param exclude: The file owner to exclude from the tree.</span>

<span class="sd">        :returns: A tree as described above.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_directory</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">children</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">child</span><span class="o">.</span><span class="n">list_contents</span><span class="p">(</span><span class="n">exclude</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_sorted_children</span><span class="p">(</span><span class="n">exclude</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                <span class="s2">&quot;entries&quot;</span><span class="p">:</span> <span class="n">children</span><span class="p">,</span>
            <span class="p">}</span></div>

    <span class="k">def</span> <span class="nf">get_sorted_children</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exclude</span><span class="p">:</span> <span class="n">FileOwner</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="s1">&#39;File&#39;</span><span class="p">]:</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">File</span><span class="o">.</span><span class="n">fileowner</span> <span class="o">!=</span> <span class="n">exclude</span><span class="p">),</span>
            <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">el</span><span class="p">:</span> <span class="n">el</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span>
        <span class="p">)</span>

<div class="viewcode-block" id="File.rename_code"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.File.rename_code">[docs]</a>    <span class="k">def</span> <span class="nf">rename_code</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">new_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">new_parent</span><span class="p">:</span> <span class="s1">&#39;File&#39;</span><span class="p">,</span>
        <span class="n">exclude_owner</span><span class="p">:</span> <span class="n">FileOwner</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Rename the this file to the given new name.</span>

<span class="sd">        :param new_name: The new name to be given to the given file.</span>
<span class="sd">        :param new_parent: The new parent of this file.</span>
<span class="sd">        :param exclude_owner: The owner to exclude while searching for</span>
<span class="sd">            collisions.</span>
<span class="sd">        :returns: Nothing.</span>

<span class="sd">        :raises APIException: If renaming would result in a naming collision</span>
<span class="sd">            (INVALID_STATE).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">new_parent</span><span class="o">.</span><span class="n">children</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">new_name</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">File</span><span class="o">.</span><span class="n">fileowner</span> <span class="o">!=</span> <span class="n">exclude_owner</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">psef</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">APIException</span><span class="p">(</span>
                <span class="s1">&#39;This file already exists within this directory&#39;</span><span class="p">,</span>
                <span class="n">f</span><span class="s1">&#39;The file &quot;</span><span class="si">{new_parent.id}</span><span class="s1">&quot; has &#39;</span>
                <span class="n">f</span><span class="s1">&#39;a child with the name &quot;</span><span class="si">{new_name}</span><span class="s1">&quot;&#39;</span><span class="p">,</span>
                <span class="n">psef</span><span class="o">.</span><span class="n">errors</span><span class="o">.</span><span class="n">APICodes</span><span class="o">.</span><span class="n">INVALID_STATE</span><span class="p">,</span> <span class="mi">400</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">new_name</span></div>

<div class="viewcode-block" id="File.__to_json__"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.File.__to_json__">[docs]</a>    <span class="k">def</span> <span class="nf">__to_json__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">,</span> <span class="nb">int</span><span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Creates a JSON serializable representation of this object.</span>


<span class="sd">        This object will look like this:</span>

<span class="sd">        .. code:: python</span>

<span class="sd">            {</span>
<span class="sd">                &#39;name&#39;: str, # The name of the file or directory.</span>
<span class="sd">                &#39;id&#39;: int, # The id of this file.</span>
<span class="sd">                &#39;is_directory&#39;: bool, # Is this file a directory.</span>
<span class="sd">            }</span>

<span class="sd">        :returns: A object as described above.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;is_directory&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_directory</span><span class="p">,</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="p">}</span></div></div>


<div class="viewcode-block" id="LinterComment"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.LinterComment">[docs]</a><span class="k">class</span> <span class="nc">LinterComment</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Describes a comment created by a :class:`LinterInstance`.</span>

<span class="sd">    Like a :class:`Comment` it is attached to a specific line in a</span>
<span class="sd">    :class:`File`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">query</span>  <span class="c1"># type: t.ClassVar[_MyQuery[&#39;LinterComment&#39;]]</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;LinterComment&quot;</span>  <span class="c1"># type: str</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">file_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;File_id&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;File.id&#39;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;CASCADE&#39;</span><span class="p">),</span>
        <span class="n">index</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">linter_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;linter_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;LinterInstance.id&#39;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">line</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">)</span>
    <span class="n">linter_code</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;linter_code&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">)</span>
    <span class="n">comment</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">)</span>

    <span class="n">linter</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;LinterInstance&quot;</span><span class="p">,</span> <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;comments&quot;</span>
    <span class="p">)</span>  <span class="c1"># type: &#39;LinterInstance&#39;</span>
    <span class="n">file</span><span class="p">:</span> <span class="n">File</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span><span class="s1">&#39;File&#39;</span><span class="p">,</span> <span class="n">foreign_keys</span><span class="o">=</span><span class="n">file_id</span><span class="p">)</span>

<div class="viewcode-block" id="LinterComment.__to_json__"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.LinterComment.__to_json__">[docs]</a>    <span class="k">def</span> <span class="nf">__to_json__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Creates a JSON serializable representation of this object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">linter_code</span><span class="p">,</span>
            <span class="s1">&#39;line&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">,</span>
            <span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">comment</span><span class="p">,</span>
        <span class="p">}</span></div></div>


<div class="viewcode-block" id="Comment"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.Comment">[docs]</a><span class="k">class</span> <span class="nc">Comment</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Describes a comment placed in a :class:`File` by a :class:`User` with</span>
<span class="sd">    the ability to grade.</span>

<span class="sd">    A comment is always linked to a specific line in a file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">query</span>  <span class="c1"># type: t.ClassVar[_MyQuery[&#39;Comment&#39;]]</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;Comment&quot;</span>
    <span class="n">file_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;File_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;File.id&#39;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;CASCADE&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;User_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;User.id&#39;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;CASCADE&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">line</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;line&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">)</span>
    <span class="n">comment</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;comment&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">)</span>
    <span class="n">__table_args__</span> <span class="o">=</span> <span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">PrimaryKeyConstraint</span><span class="p">(</span><span class="n">file_id</span><span class="p">,</span> <span class="n">line</span><span class="p">),</span> <span class="p">)</span>

    <span class="n">file</span><span class="p">:</span> <span class="n">File</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span><span class="s1">&#39;File&#39;</span><span class="p">,</span> <span class="n">foreign_keys</span><span class="o">=</span><span class="n">file_id</span><span class="p">)</span>
    <span class="n">user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span><span class="s1">&#39;User&#39;</span><span class="p">,</span> <span class="n">foreign_keys</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>

<div class="viewcode-block" id="Comment.__to_json__"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.Comment.__to_json__">[docs]</a>    <span class="k">def</span> <span class="nf">__to_json__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Creates a JSON serializable representation of this object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;line&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">line</span><span class="p">,</span>
            <span class="s1">&#39;msg&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">comment</span><span class="p">,</span>
        <span class="p">}</span></div></div>


<div class="viewcode-block" id="LinterState"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.LinterState">[docs]</a><span class="nd">@enum</span><span class="o">.</span><span class="n">unique</span>
<span class="k">class</span> <span class="nc">LinterState</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Describes in what state a :class:`LinterInstance` is.</span>

<span class="sd">    :param running: The linter is currently running.</span>
<span class="sd">    :param done: The linter has finished without crashing.</span>
<span class="sd">    :param crashed: The linter has crashed in some way.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">running</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">done</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span>
    <span class="n">crashed</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">3</span></div>


<div class="viewcode-block" id="AssignmentLinter"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.AssignmentLinter">[docs]</a><span class="k">class</span> <span class="nc">AssignmentLinter</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The class is used when a linter (see :py:mod:`psef.linters`) is used on</span>
<span class="sd">    a :class:`Assignment`.</span>

<span class="sd">    Every :class:`Work` that is tested is attached by a</span>
<span class="sd">    :class:`LinterInstance`.</span>

<span class="sd">    The name identifies which :class:`.linters.Linter` is used.</span>

<span class="sd">    :ivar name: The name of the linter which is the `__name__` of a subclass of</span>
<span class="sd">        :py:class:`linters.Linter`.</span>
<span class="sd">    :ivar tests: All the linter instances for this linter, this are the</span>
<span class="sd">        recordings of the running of the actual linter (so in the case of the</span>
<span class="sd">        :py:class:`linters.Flake8` metadata about the `flake8` program).</span>
<span class="sd">    :ivar config: The config that was passed to the linter.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">query</span>  <span class="c1"># type: t.ClassVar[_MyQuery[&#39;AssignmentLinter&#39;]]</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;AssignmentLinter&#39;</span>  <span class="c1"># type: str</span>
    <span class="c1"># This has to be a String object as the id has to be a non guessable uuid.</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">UUID_LENGTH</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">)</span>
    <span class="n">tests</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;LinterInstance&quot;</span><span class="p">,</span>
        <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;tester&quot;</span><span class="p">,</span>
        <span class="n">cascade</span><span class="o">=</span><span class="s1">&#39;all,delete&#39;</span><span class="p">,</span>
        <span class="n">order_by</span><span class="o">=</span><span class="s1">&#39;LinterInstance.work_id&#39;</span>
    <span class="p">)</span>  <span class="c1"># type: t.Sequence[LinterInstance]</span>
    <span class="n">config</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;config&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">assignment_id</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;Assignment_id&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Assignment.id&#39;</span><span class="p">),</span>
    <span class="p">)</span>  <span class="c1"># type: int</span>

    <span class="n">assignment</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="s1">&#39;Assignment&#39;</span><span class="p">,</span>
        <span class="n">foreign_keys</span><span class="o">=</span><span class="n">assignment_id</span><span class="p">,</span>
        <span class="n">backref</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">backref</span><span class="p">(</span><span class="s1">&#39;linters&#39;</span><span class="p">,</span> <span class="n">uselist</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="p">)</span>  <span class="c1"># type: &#39;Assignment&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">linters_crashed</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The amount of linters that have crashed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_amount_linters_in_state</span><span class="p">(</span><span class="n">LinterState</span><span class="o">.</span><span class="n">crashed</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">linters_done</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The amount of linters that are done.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_amount_linters_in_state</span><span class="p">(</span><span class="n">LinterState</span><span class="o">.</span><span class="n">done</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">linters_running</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The amount of linters that are running.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_amount_linters_in_state</span><span class="p">(</span><span class="n">LinterState</span><span class="o">.</span><span class="n">running</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_amount_linters_in_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">LinterState</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">LinterInstance</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span>
            <span class="n">tester_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">state</span><span class="o">=</span><span class="n">state</span>
        <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

<div class="viewcode-block" id="AssignmentLinter.__to_json__"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.AssignmentLinter.__to_json__">[docs]</a>    <span class="k">def</span> <span class="nf">__to_json__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Returns the JSON serializable representation of this class.</span>

<span class="sd">        This representation also returns a count of the :class:`LinterState` of</span>
<span class="sd">        the attached :class:`LinterInstance` objects.</span>

<span class="sd">        :returns: A dict containing JSON serializable representations of the</span>
<span class="sd">                  attributes and the test state counts of this</span>
<span class="sd">                  AssignmentLinter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;done&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">linters_done</span><span class="p">,</span>
            <span class="s1">&#39;working&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">linters_running</span><span class="p">,</span>
            <span class="s1">&#39;crashed&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">linters_crashed</span><span class="p">,</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="p">}</span></div>

<div class="viewcode-block" id="AssignmentLinter.create_linter"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.AssignmentLinter.create_linter">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">create_linter</span><span class="p">(</span>
        <span class="bp">cls</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="s1">&#39;AssignmentLinter&#39;</span><span class="p">],</span>
        <span class="n">assignment_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">config</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;AssignmentLinter&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Create a new instance of this class for a given :class:`Assignment`</span>
<span class="sd">        with a given :py:class:`.linters.Linter`</span>

<span class="sd">        :param assignment_id: The id of the assignment</span>
<span class="sd">        :param name: Name of the linter</span>
<span class="sd">        :returns: The created AssignmentLinter</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>

        <span class="c1"># Find a unique id.</span>
        <span class="k">while</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="n">AssignmentLinter</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">new_id</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
        <span class="p">)</span><span class="o">.</span><span class="n">scalar</span><span class="p">():</span>  <span class="c1"># pragma: no cover</span>
            <span class="n">new_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>

        <span class="bp">self</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">new_id</span><span class="p">,</span> <span class="n">assignment_id</span><span class="o">=</span><span class="n">assignment_id</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">tests</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">work</span> <span class="ow">in</span> <span class="n">Assignment</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">assignment_id</span>
                                         <span class="p">)</span><span class="o">.</span><span class="n">get_all_latest_submissions</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tests</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">LinterInstance</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="bp">self</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">self</span></div></div>


<div class="viewcode-block" id="LinterInstance"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.LinterInstance">[docs]</a><span class="k">class</span> <span class="nc">LinterInstance</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Describes the connection between a :class:`AssignmentLinter` and a</span>
<span class="sd">    :class:`Work`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">query</span>  <span class="c1"># type: t.ClassVar[_MyQuery[&#39;LinterInstance&#39;]]</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;LinterInstance&#39;</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">String</span><span class="p">(</span><span class="n">UUID_LENGTH</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">LinterState</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;state&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="n">LinterState</span><span class="p">),</span>
        <span class="n">default</span><span class="o">=</span><span class="n">LinterState</span><span class="o">.</span><span class="n">running</span><span class="p">,</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="n">work_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;Work_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Work.id&#39;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;CASCADE&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">tester_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;tester_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;AssignmentLinter.id&#39;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">tester</span><span class="p">:</span> <span class="n">AssignmentLinter</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;AssignmentLinter&quot;</span><span class="p">,</span> <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;tests&quot;</span>
    <span class="p">)</span>
    <span class="n">work</span><span class="p">:</span> <span class="n">Work</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span><span class="s1">&#39;Work&#39;</span><span class="p">,</span> <span class="n">foreign_keys</span><span class="o">=</span><span class="n">work_id</span><span class="p">)</span>

    <span class="n">comments</span><span class="p">:</span> <span class="n">LinterComment</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;LinterComment&quot;</span><span class="p">,</span> <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;linter&quot;</span><span class="p">,</span> <span class="n">cascade</span><span class="o">=</span><span class="s1">&#39;all,delete&#39;</span>
    <span class="p">)</span>

<div class="viewcode-block" id="LinterInstance.__init__"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.LinterInstance.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">work</span><span class="p">:</span> <span class="n">Work</span><span class="p">,</span> <span class="n">tester</span><span class="p">:</span> <span class="n">AssignmentLinter</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">work</span><span class="o">=</span><span class="n">work</span><span class="p">,</span> <span class="n">tester</span><span class="o">=</span><span class="n">tester</span><span class="p">)</span>

        <span class="c1"># Find a unique id</span>
        <span class="n">new_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>
        <span class="k">while</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="n">LinterInstance</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">LinterInstance</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">new_id</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
        <span class="p">)</span><span class="o">.</span><span class="n">scalar</span><span class="p">():</span>  <span class="c1"># pragma: no cover</span>
            <span class="n">new_id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">new_id</span></div>

<div class="viewcode-block" id="LinterInstance.add_comments"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.LinterInstance.add_comments">[docs]</a>    <span class="k">def</span> <span class="nf">add_comments</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">feedbacks</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span>
                             <span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="n">LinterComment</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Add comments written by this instance.</span>

<span class="sd">        :param feedbacks: The feedback to add, it should be in form as</span>
<span class="sd">            described below.</span>
<span class="sd">        :returns: A iterable with comments that have not been added or commited</span>
<span class="sd">            to the database yet.</span>

<span class="sd">        .. code:: python</span>

<span class="sd">            {</span>
<span class="sd">                file_id: {</span>
<span class="sd">                    line_number: [(linter_code, msg), ...]</span>
<span class="sd">                }</span>
<span class="sd">            }</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">file_id</span><span class="p">,</span> <span class="n">feedback</span> <span class="ow">in</span> <span class="n">feedbacks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">line_number</span><span class="p">,</span> <span class="n">msgs</span> <span class="ow">in</span> <span class="n">feedback</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">linter_code</span><span class="p">,</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">msgs</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">LinterComment</span><span class="p">(</span>
                        <span class="n">file_id</span><span class="o">=</span><span class="n">file_id</span><span class="p">,</span>
                        <span class="n">line</span><span class="o">=</span><span class="n">line_number</span><span class="p">,</span>
                        <span class="n">linter_code</span><span class="o">=</span><span class="n">linter_code</span><span class="p">,</span>
                        <span class="n">linter_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                        <span class="n">comment</span><span class="o">=</span><span class="n">msg</span><span class="p">,</span>
                    <span class="p">)</span></div></div>


<span class="nd">@enum</span><span class="o">.</span><span class="n">unique</span>
<span class="k">class</span> <span class="nc">_AssignmentStateEnum</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Describes in what state an :class:`Assignment` is.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">hidden</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="nb">open</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">done</span> <span class="o">=</span> <span class="mi">2</span>


<div class="viewcode-block" id="AssignmentDoneType"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.AssignmentDoneType">[docs]</a><span class="nd">@enum</span><span class="o">.</span><span class="n">unique</span>
<span class="k">class</span> <span class="nc">AssignmentDoneType</span><span class="p">(</span><span class="n">enum</span><span class="o">.</span><span class="n">IntEnum</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Describes what type of reminder should be sent.</span>

<span class="sd">    :param none: Nobody should be e-mailed.</span>
<span class="sd">    :param assigned_only: Only graders that are assigned will be notified.</span>
<span class="sd">    :param all_graders: All users that have the permission to grade.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">assigned_only</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">all_graders</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">2</span></div>


<div class="viewcode-block" id="Assignment"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.Assignment">[docs]</a><span class="k">class</span> <span class="nc">Assignment</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class describes a :class:`Course` specific assignment.</span>

<span class="sd">    :ivar name: The name of the assignment.</span>
<span class="sd">    :ivar cgignore: The .cgignore file of this assignment.</span>
<span class="sd">    :ivar state: The current state the assignment is in.</span>
<span class="sd">    :ivar description: UNUSED</span>
<span class="sd">    :ivar course: The course this assignment belongs to.</span>
<span class="sd">    :ivar created_at: The date this assignment was added.</span>
<span class="sd">    :ivar deadline: The deadline of this assignment.</span>
<span class="sd">    :ivar _mail_task_id: This is the id of the current task that will email all</span>
<span class="sd">        the TA&#39;s to hurry up with grading.</span>
<span class="sd">    :ivar reminder_email_time: The time the reminder email should be sent. To</span>
<span class="sd">        see if we should actually send these reminders look at `done_type`</span>
<span class="sd">    :ivar done_email: The email address we should sent a email if the grading</span>
<span class="sd">        is done. The function :py:func:`email.utils.getaddresses` should be</span>
<span class="sd">        able to parse this string.</span>
<span class="sd">    :ivar done_type: The type of reminder that should be sent.</span>
<span class="sd">    :ivar assigned_graders: All graders that are assigned to grade mapped by</span>
<span class="sd">        user_id to `AssignmentAssignedGrader` object.</span>
<span class="sd">    :ivar rubric_rows: The rubric rows that make up the rubric for this</span>
<span class="sd">        assignment.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">query</span>  <span class="c1"># type:  t.ClassVar[_MyQuery[&#39;Assignment&#39;]]</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;Assignment&quot;</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">)</span>
    <span class="n">cgignore</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;cgignore&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">)</span>
    <span class="n">state</span><span class="p">:</span> <span class="n">_AssignmentStateEnum</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;state&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="n">_AssignmentStateEnum</span><span class="p">),</span>
        <span class="n">default</span><span class="o">=</span><span class="n">_AssignmentStateEnum</span><span class="o">.</span><span class="n">hidden</span><span class="p">,</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">course_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;Course_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Course.id&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">created_at</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span>
    <span class="p">)</span>
    <span class="n">deadline</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;deadline&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">)</span>

    <span class="n">_mail_task_id</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;mail_task_id&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">reminder_email_time</span><span class="p">:</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;reminder_email_time&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">done_email</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;done_email&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">done_type</span><span class="p">:</span> <span class="n">AssignmentDoneType</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;done_type&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Enum</span><span class="p">(</span><span class="n">AssignmentDoneType</span><span class="p">),</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># All stuff for LTI</span>
    <span class="n">lti_assignment_id</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">lti_outcome_service_url</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">)</span>

    <span class="n">assigned_graders</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">MutableMapping</span><span class="p">[</span>
        <span class="nb">int</span><span class="p">,</span> <span class="n">AssignmentAssignedGrader</span>
    <span class="p">]</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="s1">&#39;AssignmentAssignedGrader&#39;</span><span class="p">,</span>
        <span class="n">cascade</span><span class="o">=</span><span class="s1">&#39;delete-orphan, delete&#39;</span><span class="p">,</span>
        <span class="n">collection_class</span><span class="o">=</span><span class="n">attribute_mapped_collection</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">),</span>
        <span class="n">backref</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">backref</span><span class="p">(</span><span class="s1">&#39;assignment&#39;</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;select&#39;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">finished_graders</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="s1">&#39;AssignmentGraderDone&#39;</span><span class="p">,</span>
        <span class="n">backref</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">backref</span><span class="p">(</span><span class="s1">&#39;assignment&#39;</span><span class="p">),</span>
        <span class="n">cascade</span><span class="o">=</span><span class="s1">&#39;delete-orphan, delete&#39;</span><span class="p">,</span>
    <span class="p">)</span>  <span class="c1"># type: t.MutableSequence[&#39;AssignmentGraderDone&#39;]</span>

    <span class="n">assignment_results</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">MutableMapping</span><span class="p">[</span>
        <span class="nb">int</span><span class="p">,</span> <span class="n">AssignmentResult</span>
    <span class="p">]</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="s1">&#39;AssignmentResult&#39;</span><span class="p">,</span>
        <span class="n">collection_class</span><span class="o">=</span><span class="n">attribute_mapped_collection</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">),</span>
        <span class="n">backref</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">backref</span><span class="p">(</span><span class="s1">&#39;assignment&#39;</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;select&#39;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="n">course</span><span class="p">:</span> <span class="n">Course</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="s1">&#39;Course&#39;</span><span class="p">,</span>
        <span class="n">foreign_keys</span><span class="o">=</span><span class="n">course_id</span><span class="p">,</span>
        <span class="n">back_populates</span><span class="o">=</span><span class="s1">&#39;assignments&#39;</span><span class="p">,</span>
        <span class="n">lazy</span><span class="o">=</span><span class="s1">&#39;joined&#39;</span>
    <span class="p">)</span>

    <span class="n">fixed_max_rubric_points</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;fixed_max_rubric_points&#39;</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">Float</span><span class="p">,</span>
        <span class="n">nullable</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">rubric_rows</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="s1">&#39;RubricRow&#39;</span><span class="p">,</span>
        <span class="n">backref</span><span class="o">=</span><span class="n">db</span><span class="o">.</span><span class="n">backref</span><span class="p">(</span><span class="s1">&#39;assignment&#39;</span><span class="p">),</span>
        <span class="n">cascade</span><span class="o">=</span><span class="s1">&#39;delete-orphan, delete&#39;</span><span class="p">,</span>
        <span class="n">order_by</span><span class="o">=</span><span class="s2">&quot;RubricRow.created_at&quot;</span>
    <span class="p">)</span>  <span class="c1"># type: t.MutableSequence[&#39;RubricRow&#39;]</span>

    <span class="c1"># This variable is available through a backref</span>
    <span class="n">linters</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="s1">&#39;AssignmentLinter&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_submit_grades</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">subs</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span>
            <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_from_latest_submissions</span><span class="p">(</span><span class="n">Work</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">subs</span><span class="p">),</span> <span class="mi">10</span><span class="p">):</span>
            <span class="n">psef</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">passback_grades</span><span class="p">([</span><span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">subs</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span> <span class="o">+</span> <span class="mi">10</span><span class="p">]])</span>

<div class="viewcode-block" id="Assignment.change_notifications"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.Assignment.change_notifications">[docs]</a>    <span class="k">def</span> <span class="nf">change_notifications</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">done_type</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">AssignmentDoneType</span><span class="p">],</span>
        <span class="n">grader_date</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">],</span>
        <span class="n">done_email</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Change the notifications for the current assignment.</span>

<span class="sd">        :param done_type: How to determine when the assignment is done. Set</span>
<span class="sd">            this value to ``None`` to disable the reminder for this assignment.</span>
<span class="sd">        :param grader_date: The datetime when to send graders that are causing</span>
<span class="sd">            the assignment to be not done a reminder email.</span>
<span class="sd">        :param done_email: The email to send a notification when grading for</span>
<span class="sd">            this assignment is done.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mail_task_id</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">psef</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">celery</span><span class="o">.</span><span class="n">control</span><span class="o">.</span><span class="n">revoke</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mail_task_id</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">done_type</span> <span class="o">=</span> <span class="n">done_type</span>

        <span class="c1"># Make sure _reminder_email_time is ``None`` if ``done_type`` is</span>
        <span class="c1"># ``none``</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reminder_email_time</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">done_type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">grader_date</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">done_email</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">done_type</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">done_email</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reminder_email_time</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Make sure id is reset so we don&#39;t revoke it multiple times</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mail_task_id</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">psef</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">send_reminder_mails</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="p">),</span> <span class="n">eta</span><span class="o">=</span><span class="n">grader_date</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_mail_task_id</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">id</span></div>

<div class="viewcode-block" id="Assignment.graders_are_done"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.Assignment.graders_are_done">[docs]</a>    <span class="k">def</span> <span class="nf">graders_are_done</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if the graders of this assignment are done.</span>

<span class="sd">        :returns: A boolean indicating if the graders of this assignment are</span>
<span class="sd">            done.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">done_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># We are never done as we have no condition to be done</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">done_type</span> <span class="o">==</span> <span class="n">AssignmentDoneType</span><span class="o">.</span><span class="n">assigned_only</span><span class="p">:</span>
            <span class="n">assigned</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_assigned_grader_ids</span><span class="p">())</span>
            <span class="n">finished</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">fg</span><span class="o">.</span><span class="n">user_id</span> <span class="k">for</span> <span class="n">fg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">finished_graders</span><span class="p">)</span>
            <span class="c1"># Check if every assigned grader is done.</span>
            <span class="k">return</span> <span class="n">assigned</span><span class="o">.</span><span class="n">issubset</span><span class="p">(</span><span class="n">finished</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">done_type</span> <span class="o">==</span> <span class="n">AssignmentDoneType</span><span class="o">.</span><span class="n">all_graders</span><span class="p">:</span>
            <span class="c1"># All graders should be done. As finished_graders all have unique</span>
            <span class="c1"># user ids we simply need to check if the lengths are the same</span>
            <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">finished_graders</span><span class="p">)</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_graders</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

        <span class="c1"># This is needed because of https://github.com/python/mypy/issues/4223</span>
        <span class="c1"># and to please pylint</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="n">f</span><span class="s1">&#39;The assignment has a invalid `done_type`: </span><span class="si">{self.done_type}</span><span class="s1">&#39;</span>
        <span class="p">)</span>  <span class="c1"># pragma: no cover</span></div>

<div class="viewcode-block" id="Assignment.get_assigned_grader_ids"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.Assignment.get_assigned_grader_ids">[docs]</a>    <span class="k">def</span> <span class="nf">get_assigned_grader_ids</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get the ids of all the graders that have submissions assigned.</span>

<span class="sd">        .. note::</span>

<span class="sd">            This only gets graders with latest submissions assigned to them.</span>

<span class="sd">        :returns: The ids of the all the graders that have work assigned within</span>
<span class="sd">            this assignnment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">map</span><span class="p">(</span>
            <span class="n">itemgetter</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_from_latest_submissions</span><span class="p">(</span>
                <span class="n">Work</span><span class="o">.</span><span class="n">assigned_to</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">(),</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Assignment.set_graders_to_not_done"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.Assignment.set_graders_to_not_done">[docs]</a>    <span class="k">def</span> <span class="nf">set_graders_to_not_done</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">user_ids</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span>
        <span class="n">send_mail</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">ignore_errors</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Set the status of the given graders to &#39;not done&#39;.</span>

<span class="sd">        :param user_ids: The ids of the users that should be set to &#39;not done&#39;</span>
<span class="sd">        :param send_mail: If ``True`` the users who are reset to &#39;not done&#39;</span>
<span class="sd">            will get an email notifying them of this.</span>
<span class="sd">        :param ignore_errors: Do not raise an error if a user in ``user_ids``</span>
<span class="sd">            was not yet done.</span>
<span class="sd">        :raise ValueError: If a user in ``user_ids`` was not yet done. This can</span>
<span class="sd">            happen because the user has not indicated this yet, because this</span>
<span class="sd">            user does not exist or because of any reason.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user_ids</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">graders</span> <span class="o">=</span> <span class="n">AssignmentGraderDone</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">AssignmentGraderDone</span><span class="o">.</span><span class="n">assignment_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="n">AssignmentGraderDone</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span><span class="n">user_ids</span><span class="p">),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">ignore_errors</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">graders</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_ids</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Not all graders were found&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">grader</span> <span class="ow">in</span> <span class="n">graders</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">send_mail</span><span class="p">:</span>
                <span class="n">psef</span><span class="o">.</span><span class="n">tasks</span><span class="o">.</span><span class="n">send_grader_status_mail</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">grader</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">grader</span><span class="p">)</span></div>

<div class="viewcode-block" id="Assignment.has_non_graded_submissions"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.Assignment.has_non_graded_submissions">[docs]</a>    <span class="k">def</span> <span class="nf">has_non_graded_submissions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if the user with the given ``user_id`` has submissions</span>
<span class="sd">        assigned without a grade.</span>

<span class="sd">        :param user_id: The id of the user to check for</span>
<span class="sd">        :returns: A boolean indicating if user has work assigned that does not</span>
<span class="sd">            have grade or a selected rubric item</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">latest</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_from_latest_submissions</span><span class="p">(</span><span class="n">Work</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
        <span class="n">sql</span> <span class="o">=</span> <span class="n">latest</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">Work</span><span class="o">.</span><span class="n">assigned_to</span> <span class="o">==</span> <span class="n">user_id</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">work_rubric_item</span><span class="p">,</span>
            <span class="n">work_rubric_item</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">work_id</span> <span class="o">==</span> <span class="n">Work</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">isouter</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span><span class="o">.</span><span class="n">having</span><span class="p">(</span>
            <span class="n">and_</span><span class="p">(</span>
                <span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">work_rubric_item</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">rubricitem_id</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span>
                <span class="c1"># We access _grade here directly as we need it to do this query</span>
                <span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">DbColumn</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]],</span> <span class="n">Work</span><span class="o">.</span><span class="n">_grade</span><span class="p">)</span><span class="o">.</span><span class="n">is_</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>  <span class="c1"># pylint: disable=protected-access</span>
            <span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">Work</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">sql</span><span class="o">.</span><span class="n">exists</span><span class="p">())</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_lti</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Is this assignment a LTI assignment.</span>

<span class="sd">        :returns: A boolean indicating if this is the case.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lti_outcome_service_url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">max_rubric_points</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Get the maximum amount of points possible for the rubric</span>

<span class="sd">        .. note::</span>

<span class="sd">          This is always higher than zero (so also not zero).</span>


<span class="sd">        :returns: The maximum amount of points.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixed_max_rubric_points</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixed_max_rubric_points</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_dynamic_max_points</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span> <span class="nf">_dynamic_max_points</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="n">func</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">RubricItem</span><span class="o">.</span><span class="n">points</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;max_val&#39;</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">RubricRow</span><span class="p">,</span> <span class="n">RubricRow</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">RubricItem</span><span class="o">.</span><span class="n">rubricrow_id</span>
               <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">RubricRow</span><span class="o">.</span><span class="n">assignment_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span>
                   <span class="n">RubricRow</span><span class="o">.</span><span class="n">id</span>
               <span class="p">)</span><span class="o">.</span><span class="n">subquery</span><span class="p">(</span><span class="s1">&#39;sub&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sub</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">max_val</span><span class="p">))</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_open</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Is the current assignment open, which means the assignment is in the</span>
<span class="sd">        state students submit work.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">_AssignmentStateEnum</span><span class="o">.</span><span class="n">open</span> <span class="ow">and</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">deadline</span> <span class="o">&gt;=</span> <span class="n">psef</span><span class="o">.</span><span class="n">helpers</span><span class="o">.</span><span class="n">get_request_start_time</span><span class="p">()</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_hidden</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Is the assignment hidden.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">_AssignmentStateEnum</span><span class="o">.</span><span class="n">hidden</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_done</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Is the assignment done, which means that grades are open.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">_AssignmentStateEnum</span><span class="o">.</span><span class="n">done</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">should_passback</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Should we passback the current grade.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_done</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">state_name</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;The current name of the grade.</span>

<span class="sd">        .. warning:: This is not the same as ``str(self.state)``.</span>

<span class="sd">        :returns: The correct name of the current state.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">_AssignmentStateEnum</span><span class="o">.</span><span class="n">open</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;submitting&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_open</span> <span class="k">else</span> <span class="s1">&#39;grading&#39;</span>
        <span class="k">return</span> <span class="n">_AssignmentStateEnum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">)</span><span class="o">.</span><span class="n">name</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">whitespace_linter_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Does this assignment have a whitespace linter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=attribute-defined-outside-init</span>
        <span class="c1"># _whitespace_linter_exists is a cache property, so this is why it is</span>
        <span class="c1"># defined outside of the init.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_whitespace_linter_exists&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_whitespace_linter_exists</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
                <span class="n">AssignmentLinter</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">AssignmentLinter</span><span class="o">.</span><span class="n">assignment_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">AssignmentLinter</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;MixedWhitespace&#39;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
            <span class="p">)</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_whitespace_linter_exists</span>

    <span class="nd">@whitespace_linter_exists</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">whitespace_linter_exists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exists</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Preset the cache for ``whitespace_linter_exists`` reducing the</span>
<span class="sd">        amount of queries needed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pylint: disable=attribute-defined-outside-init</span>
        <span class="c1"># _whitespace_linter_exists is a cache property, so this is why it is</span>
        <span class="c1"># defined outside of the init.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_whitespace_linter_exists</span> <span class="o">=</span> <span class="n">exists</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">whitespace_linter</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if this assignment has an associated MixedWhitespace linter.</span>

<span class="sd">        .. note::</span>

<span class="sd">            If the assignment is not yet done we check if the ``current_user``</span>
<span class="sd">            has the permission ``can_see_grade_before_open``.</span>

<span class="sd">        :returns: True if there is an :py:class:`.AssignmentLinter` with name</span>
<span class="sd">            ``MixedWhitespace`` and ``assignment_id``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_done</span><span class="p">:</span>
                <span class="n">psef</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">ensure_permission</span><span class="p">(</span>
                    <span class="s1">&#39;can_see_grade_before_open&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">course_id</span>
                <span class="p">)</span>
        <span class="k">except</span> <span class="n">psef</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">PermissionException</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitespace_linter_exists</span>

<div class="viewcode-block" id="Assignment.__to_json__"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.Assignment.__to_json__">[docs]</a>    <span class="k">def</span> <span class="nf">__to_json__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Creates a JSON serializable representation of this assignment.</span>

<span class="sd">        This object will look like this:</span>

<span class="sd">        .. code:: python</span>

<span class="sd">            {</span>
<span class="sd">                &#39;id&#39;: int, # The id of this assignment.</span>
<span class="sd">                &#39;state&#39;: str, # Current state of this assignment.</span>
<span class="sd">                &#39;description&#39;: str, # Description of this assignment.</span>
<span class="sd">                &#39;created_at&#39;: str, # ISO UTC date.</span>
<span class="sd">                &#39;deadline&#39;: str, # ISO UTC date.</span>
<span class="sd">                &#39;name&#39;: str, # Assignment name.</span>
<span class="sd">                &#39;is_lti&#39;: bool, # Is this an LTI assignment.</span>
<span class="sd">                &#39;course&#39;: models.Course, # Course of this assignment.</span>
<span class="sd">                &#39;cgignore&#39;: str, # The cginore of this assignment.</span>
<span class="sd">                &#39;whitespace_linter&#39;: bool, # Has the whitespace linter</span>
<span class="sd">                                           # run on this assignment.</span>
<span class="sd">                &#39;done_type&#39;: str, # The kind of reminder that will be sent.</span>
<span class="sd">                                  # If you don&#39;t have the permission to see</span>
<span class="sd">                                  # this it will always be `null`. If this is</span>
<span class="sd">                                  # not set it will also be `null`.</span>
<span class="sd">                &#39;reminder_time&#39;: str, # ISO UTC date. This will be `null` if</span>
<span class="sd">                                      # you don&#39;t have the permission to see</span>
<span class="sd">                                      # this or if it is unset.</span>
<span class="sd">                &#39;fixed_max_rubric_points&#39;: float, # The fixed value for the</span>
<span class="sd">                                                  # maximum that can be</span>
<span class="sd">                                                  # achieved in a rubric. This</span>
<span class="sd">                                                  # can be higher and lower</span>
<span class="sd">                                                  # than the actual max. Will</span>
<span class="sd">                                                  # be `null` if unset.</span>
<span class="sd">            }</span>

<span class="sd">        :returns: An object as described above.</span>

<span class="sd">        .. todo:: Remove &#39;description&#39; field from Assignment model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">res</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;state&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">state_name</span><span class="p">,</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
            <span class="s1">&#39;created_at&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">created_at</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;deadline&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">deadline</span><span class="o">.</span><span class="n">isoformat</span><span class="p">(),</span>
            <span class="s1">&#39;name&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
            <span class="s1">&#39;is_lti&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_lti</span><span class="p">,</span>
            <span class="s1">&#39;course&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">course</span><span class="p">,</span>
            <span class="s1">&#39;cgignore&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">cgignore</span><span class="p">,</span>
            <span class="s1">&#39;whitespace_linter&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">whitespace_linter</span><span class="p">,</span>
            <span class="s1">&#39;done_type&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;done_email&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;reminder_time&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;fixed_max_rubric_points&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">fixed_max_rubric_points</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">psef</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">ensure_permission</span><span class="p">(</span>
                <span class="s1">&#39;can_grade_work&#39;</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">course_id</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">done_email</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="s1">&#39;done_email&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">done_email</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">done_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="s1">&#39;done_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">done_type</span><span class="o">.</span><span class="n">name</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reminder_email_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">res</span><span class="p">[</span><span class="s1">&#39;reminder_time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reminder_email_time</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">psef</span><span class="o">.</span><span class="n">auth</span><span class="o">.</span><span class="n">PermissionException</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">return</span> <span class="n">res</span></div>

<div class="viewcode-block" id="Assignment.set_state"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.Assignment.set_state">[docs]</a>    <span class="k">def</span> <span class="nf">set_state</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Update the current state (class:`_AssignmentStateEnum`).</span>

<span class="sd">        You can update the state to hidden, done or open. A assignment can not</span>
<span class="sd">        be updated to &#39;submitting&#39; or &#39;grading&#39; as this is an assignment with</span>
<span class="sd">        state of &#39;open&#39; and, respectively, a deadline before or after the</span>
<span class="sd">        current time.</span>

<span class="sd">        :param state: The new state, can be &#39;hidden&#39;, &#39;done&#39; or &#39;open&#39;</span>
<span class="sd">        :returns: Nothing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;open&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">_AssignmentStateEnum</span><span class="o">.</span><span class="n">open</span>
        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;hidden&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">_AssignmentStateEnum</span><span class="o">.</span><span class="n">hidden</span>
        <span class="k">elif</span> <span class="n">state</span> <span class="o">==</span> <span class="s1">&#39;done&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">_AssignmentStateEnum</span><span class="o">.</span><span class="n">done</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">lti_outcome_service_url</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_submit_grades</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span></div>

<div class="viewcode-block" id="Assignment.get_from_latest_submissions"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.Assignment.get_from_latest_submissions">[docs]</a>    <span class="k">def</span> <span class="nf">get_from_latest_submissions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">to_query</span><span class="p">:</span> <span class="n">T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;_MyQuery[T]&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get the given fields from all last submitted submissions.</span>

<span class="sd">        :param to_query: The field to get from the last submitted submissions.</span>
<span class="sd">        :returns: A query object with the given fields selected from the last</span>
<span class="sd">            submissions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">sub</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="n">Work</span><span class="o">.</span><span class="n">user_id</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;user_id&#39;</span><span class="p">),</span>  <span class="c1"># type: ignore</span>
            <span class="n">func</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Work</span><span class="o">.</span><span class="n">created_at</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;max_date&#39;</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">assignment_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">Work</span><span class="o">.</span><span class="n">user_id</span>
                                                    <span class="p">)</span><span class="o">.</span><span class="n">subquery</span><span class="p">(</span><span class="s1">&#39;sub&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="o">*</span><span class="n">to_query</span><span class="p">)</span><span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="n">Work</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">sub</span><span class="p">,</span>
            <span class="n">and_</span><span class="p">(</span>
                <span class="n">sub</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">user_id</span> <span class="o">==</span> <span class="n">Work</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
                <span class="n">sub</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">max_date</span> <span class="o">==</span> <span class="n">Work</span><span class="o">.</span><span class="n">created_at</span>
            <span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Work</span><span class="o">.</span><span class="n">assignment_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">)</span></div>

<div class="viewcode-block" id="Assignment.get_all_latest_submissions"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.Assignment.get_all_latest_submissions">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_latest_submissions</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;_MyQuery[Work]&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get a list of all the latest submissions (:class:`Work`) by each</span>
<span class="sd">        :class:`User` who has submitted at least one work for this assignment.</span>

<span class="sd">        :returns: The latest submissions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># get_from_latest_submissions uses SQLAlchemy magic that MyPy cannot</span>
        <span class="c1"># encode.</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_from_latest_submissions</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">Work</span><span class="p">,</span> <span class="n">Work</span><span class="p">))</span></div>

<div class="viewcode-block" id="Assignment.get_divided_amount_missing"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.Assignment.get_divided_amount_missing">[docs]</a>    <span class="k">def</span> <span class="nf">get_divided_amount_missing</span><span class="p">(</span>
        <span class="bp">self</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span> <span class="n">t</span><span class="o">.</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">int</span><span class="p">],</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span>
                                                   <span class="p">]]:</span>
        <span class="sd">&quot;&quot;&quot;Get a mapping between user and the amount of submissions that they</span>
<span class="sd">        should be assigned but are not.</span>

<span class="sd">        For example if we have two graders, John and Dorian that respectively</span>
<span class="sd">        have the weights 1 and 1 assigned. Lets say we have three submissions</span>
<span class="sd">        divided in such a way that John has to grade 2 and Dorian has to grade</span>
<span class="sd">        one, then our function we return that John is missing -0.5 submissions</span>
<span class="sd">        and Dorian is missing 0.5.</span>

<span class="sd">        .. note::</span>

<span class="sd">            If ``self.assigned_graders`` is empty this function and its</span>
<span class="sd">            recalculate will always return an empty directory.</span>

<span class="sd">        :returns: A mapping between user int and the amount missing as</span>
<span class="sd">            described above. Furthermore it returns a function that can be used</span>
<span class="sd">            to recalculate this mapping by given it the user id of the user</span>
<span class="sd">            that was assigned a submission.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">assigned_graders</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{},</span> <span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="p">{}</span>

        <span class="n">total_weight</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">weight</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assigned_graders</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>

        <span class="n">amount_subs</span><span class="p">:</span> <span class="nb">int</span>
        <span class="n">amount_subs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_from_latest_submissions</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
            <span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span>

        <span class="n">divided_amount</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">MutableMapping</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">u_id</span><span class="p">,</span> <span class="n">amount</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_from_latest_submissions</span><span class="p">(</span>  <span class="c1"># type: ignore</span>
            <span class="n">Work</span><span class="o">.</span><span class="n">assigned_to</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="p">)</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">Work</span><span class="o">.</span><span class="n">assigned_to</span><span class="p">):</span>
            <span class="n">divided_amount</span><span class="p">[</span><span class="n">u_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">amount</span>

        <span class="n">missing</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">assigned</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assigned_graders</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">missing</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">assigned</span><span class="o">.</span><span class="n">weight</span> <span class="o">/</span> <span class="n">total_weight</span> <span class="o">*</span>
                                <span class="n">amount_subs</span><span class="p">)</span> <span class="o">-</span> <span class="n">divided_amount</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">__recalculate</span><span class="p">(</span><span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">MutableMapping</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
            <span class="k">nonlocal</span> <span class="n">amount_subs</span>

            <span class="n">amount_subs</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">divided_amount</span><span class="p">[</span><span class="n">user_id</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">missing</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">for</span> <span class="n">assigned_user_id</span><span class="p">,</span> <span class="n">assigned</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assigned_graders</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">missing</span><span class="p">[</span><span class="n">assigned_user_id</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">assigned</span><span class="o">.</span><span class="n">weight</span> <span class="o">/</span> <span class="n">total_weight</span> <span class="o">*</span>
                             <span class="n">amount_subs</span><span class="p">)</span> <span class="o">-</span> <span class="n">divided_amount</span><span class="p">[</span><span class="n">assigned_user_id</span><span class="p">]</span>

            <span class="k">return</span> <span class="n">missing</span>

        <span class="k">return</span> <span class="n">missing</span><span class="p">,</span> <span class="n">__recalculate</span></div>

    <span class="k">def</span> <span class="nf">_weights_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user_weights</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span>
                         <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Check if the given users and their weights have changed since the</span>
<span class="sd">        last division.</span>

<span class="sd">        :param user_weights: A list of tuples that map users and the weights.</span>
<span class="sd">            The weights are used to determine how many submissions should be</span>
<span class="sd">            assigned to a single user.</span>
<span class="sd">        :returns: If the weights have changed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">user_weights</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assigned_graders</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">user</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">user_weights</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">user</span><span class="o">.</span><span class="n">id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">assigned_graders</span> <span class="ow">or</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">assigned_graders</span><span class="p">[</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">]</span><span class="o">.</span><span class="n">weight</span> <span class="o">!=</span> <span class="n">weight</span>
                <span class="p">):</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>

<div class="viewcode-block" id="Assignment.divide_submissions"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.Assignment.divide_submissions">[docs]</a>    <span class="k">def</span> <span class="nf">divide_submissions</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">user_weights</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Tuple</span><span class="p">[</span><span class="n">User</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Divide all newest submissions for this assignment between the given</span>
<span class="sd">        users.</span>

<span class="sd">        This methods prefers to keep submissions assigned to the same grader as</span>
<span class="sd">        much as possible. To get completely new and random assignments first</span>
<span class="sd">        clear all old assignments.</span>

<span class="sd">        :param user_weights: A list of tuples that map users and the weights.</span>
<span class="sd">            The weights are used to determine how many submissions should be</span>
<span class="sd">            assigned to a single user.</span>
<span class="sd">        :returns: Nothing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># First check if there were changes in the weights</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_weights_changed</span><span class="p">(</span><span class="n">user_weights</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="n">submissions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_all_latest_submissions</span><span class="p">()</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="n">shuffle</span><span class="p">(</span><span class="n">submissions</span><span class="p">)</span>

        <span class="n">counts</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">MutableMapping</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">user_submissions</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">MutableMapping</span><span class="p">[</span><span class="n">t</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">Work</span><span class="p">]]</span>
        <span class="n">user_submissions</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

        <span class="c1"># Remove all users not in user_weights</span>
        <span class="n">new_users</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">id</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">user_weights</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">submission</span> <span class="ow">in</span> <span class="n">submissions</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">submission</span><span class="o">.</span><span class="n">assigned_to</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">new_users</span><span class="p">:</span>
                <span class="n">submission</span><span class="o">.</span><span class="n">assigned_to</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">counts</span><span class="p">[</span><span class="n">submission</span><span class="o">.</span><span class="n">assigned_to</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">user_submissions</span><span class="p">[</span><span class="n">submission</span><span class="o">.</span><span class="n">assigned_to</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">submission</span><span class="p">)</span>

        <span class="n">new_total_weight</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">weight</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">user_weights</span><span class="p">)</span>

        <span class="n">negative_weights</span><span class="p">,</span> <span class="n">positive_weights</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">user</span><span class="p">,</span> <span class="n">new_weight</span> <span class="ow">in</span> <span class="n">user_weights</span><span class="p">:</span>
            <span class="n">percentage</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_weight</span> <span class="o">/</span> <span class="n">new_total_weight</span><span class="p">)</span>
            <span class="n">new</span> <span class="o">=</span> <span class="n">percentage</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">submissions</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">new</span> <span class="o">&lt;</span> <span class="n">counts</span><span class="p">[</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">]:</span>
                <span class="n">negative_weights</span><span class="p">[</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">counts</span><span class="p">[</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">-</span> <span class="n">new</span>
            <span class="k">elif</span> <span class="n">new</span> <span class="o">&gt;</span> <span class="n">counts</span><span class="p">[</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">]:</span>
                <span class="n">positive_weights</span><span class="p">[</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span> <span class="o">-</span> <span class="n">counts</span><span class="p">[</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">delete_amount</span> <span class="ow">in</span> <span class="n">negative_weights</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">user_submissions</span><span class="p">[</span><span class="n">user_id</span><span class="p">][:</span><span class="nb">round</span><span class="p">(</span><span class="n">delete_amount</span><span class="p">)]:</span>
                <span class="n">user_submissions</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sub</span><span class="p">)</span>

        <span class="n">to_assign</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">positive_weights</span><span class="p">:</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">positive_weights</span><span class="o">.</span><span class="n">values</span><span class="p">())))</span>
            <span class="k">for</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">new_amount</span> <span class="ow">in</span> <span class="n">positive_weights</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">to_assign</span> <span class="o">+=</span> <span class="p">[</span><span class="n">user_id</span><span class="p">]</span> <span class="o">*</span> <span class="nb">round</span><span class="p">(</span><span class="n">new_amount</span> <span class="o">*</span> <span class="n">ratio</span><span class="p">)</span>

        <span class="n">shuffle</span><span class="p">(</span><span class="n">to_assign</span><span class="p">)</span>
        <span class="n">newly_assigned</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Set</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">sub</span><span class="p">,</span> <span class="n">user_id</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">user_submissions</span><span class="p">[</span><span class="kc">None</span><span class="p">],</span> <span class="n">cycle</span><span class="p">(</span><span class="n">to_assign</span><span class="p">)):</span>
            <span class="n">sub</span><span class="o">.</span><span class="n">assigned_to</span> <span class="o">=</span> <span class="n">user_id</span>
            <span class="n">newly_assigned</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">user_id</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">set_graders_to_not_done</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span><span class="n">newly_assigned</span><span class="p">),</span>
            <span class="n">send_mail</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">ignore_errors</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assigned_graders</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">user</span><span class="p">,</span> <span class="n">weight</span> <span class="ow">in</span> <span class="n">user_weights</span><span class="p">:</span>
            <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span>
                <span class="n">AssignmentAssignedGrader</span><span class="p">(</span>
                    <span class="n">weight</span><span class="o">=</span><span class="n">weight</span><span class="p">,</span> <span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">assignment</span><span class="o">=</span><span class="bp">self</span>
                <span class="p">)</span>
            <span class="p">)</span></div>

<div class="viewcode-block" id="Assignment.get_all_graders"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.Assignment.get_all_graders">[docs]</a>    <span class="k">def</span> <span class="nf">get_all_graders</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">sort</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="s1">&#39;_MyQuery[t.Tuple[str, int, bool]]&#39;</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;Get all graders for this assignment.</span>

<span class="sd">        The graders are retrieved from the database using a single query. The</span>
<span class="sd">        return value is a query with three items selected: the first is the</span>
<span class="sd">        name of the grader, the second is the database id of the user object</span>
<span class="sd">        of grader and the third and last is a boolean indicating if this grader</span>
<span class="sd">        is done grading. You can use this query as an iterator.</span>

<span class="sd">        :param sort: Should the graders be sorted by name.</span>
<span class="sd">        :returns: A query with items selected as described above.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">done_graders</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">DbColumn</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">),</span>
            <span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">DbColumn</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">),</span>
            <span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span>
                <span class="n">DbColumn</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span>
                <span class="o">~</span><span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">DbColumn</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">AssignmentGraderDone</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">is_</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;done&quot;</span><span class="p">),</span>
            <span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">DbColumn</span><span class="p">[</span><span class="nb">int</span><span class="p">],</span> <span class="n">user_course</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">course_id</span><span class="p">)</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;course_id&quot;</span><span class="p">),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">AssignmentGraderDone</span><span class="p">,</span>
            <span class="n">and_</span><span class="p">(</span>
                <span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">AssignmentGraderDone</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
                <span class="n">AssignmentGraderDone</span><span class="o">.</span><span class="n">assignment_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="n">isouter</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">user_course</span><span class="p">,</span>
            <span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">user_course</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">subquery</span><span class="p">(</span><span class="s1">&#39;done_graders&#39;</span><span class="p">)</span>

        <span class="n">graders</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">course_permissions</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">course_role_id</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">CourseRole</span><span class="p">,</span>
            <span class="n">CourseRole</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">course_permissions</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">course_role_id</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">Permission</span><span class="p">,</span>
            <span class="n">course_permissions</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">permission_id</span> <span class="o">==</span> <span class="n">Permission</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">CourseRole</span><span class="o">.</span><span class="n">course_id</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">course_id</span><span class="p">,</span>
            <span class="n">Permission</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;can_grade_work&#39;</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">subquery</span><span class="p">(</span><span class="s1">&#39;graders&#39;</span><span class="p">)</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span>
            <span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">done_graders</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">),</span>
            <span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="nb">int</span><span class="p">,</span> <span class="n">done_graders</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">id</span><span class="p">),</span>
            <span class="n">t</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="nb">bool</span><span class="p">,</span> <span class="n">done_graders</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">done</span><span class="p">),</span>
        <span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">graders</span><span class="p">,</span> <span class="n">done_graders</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">course_id</span> <span class="o">==</span> <span class="n">graders</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">course_role_id</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sort</span><span class="p">:</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">lower</span><span class="p">(</span><span class="n">done_graders</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">res</span></div></div>


<div class="viewcode-block" id="Snippet"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.Snippet">[docs]</a><span class="k">class</span> <span class="nc">Snippet</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Describes a :class:`User` specified mapping from a keyword to some</span>
<span class="sd">    string.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">query</span>  <span class="c1"># type: t.ClassVar[_MyQuery[&#39;Snippet&#39;]]</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;Snippet&#39;</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;key&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">value</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;value&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">user_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;User_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;User.id&#39;</span><span class="p">))</span>

    <span class="n">user</span><span class="p">:</span> <span class="n">User</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span><span class="s1">&#39;User&#39;</span><span class="p">,</span> <span class="n">foreign_keys</span><span class="o">=</span><span class="n">user_id</span><span class="p">)</span>

<div class="viewcode-block" id="Snippet.get_all_snippets"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.Snippet.get_all_snippets">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_all_snippets</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">t</span><span class="o">.</span><span class="n">Type</span><span class="p">[</span><span class="s1">&#39;Snippet&#39;</span><span class="p">],</span>
                         <span class="n">user</span><span class="p">:</span> <span class="n">User</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Sequence</span><span class="p">[</span><span class="s1">&#39;Snippet&#39;</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Return all snippets of the given :class:`User`.</span>

<span class="sd">        :param user: The user to get the snippets for.</span>
<span class="sd">        :returns: List of all snippets of the user.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">query</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">user_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></div>

<div class="viewcode-block" id="Snippet.__to_json__"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.Snippet.__to_json__">[docs]</a>    <span class="k">def</span> <span class="nf">__to_json__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Creates a JSON serializable representation of this object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;key&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">key</span><span class="p">,</span>
            <span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
        <span class="p">}</span></div></div>


<div class="viewcode-block" id="RubricRow"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.RubricRow">[docs]</a><span class="k">class</span> <span class="nc">RubricRow</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Describes a row of some rubric.</span>

<span class="sd">    This class forms the link between :class:`Assignment` and</span>
<span class="sd">    :class:`RubricItem` and holds information about the row.</span>

<span class="sd">    :ivar ~.RubricRow.assignment_id: The assignment id of the assignment that</span>
<span class="sd">        belows to this rubric row.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">query</span>  <span class="c1"># type: t.ClassVar[_MyQuery[&#39;RubricRow&#39;]]</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;RubricRow&#39;</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">assignment_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;Assignment_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;Assignment.id&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">header</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;header&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">)</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">created_at</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;created_at&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">DateTime</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">utcnow</span>
    <span class="p">)</span>
    <span class="n">items</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">relationship</span><span class="p">(</span>
        <span class="s2">&quot;RubricItem&quot;</span><span class="p">,</span> <span class="n">backref</span><span class="o">=</span><span class="s2">&quot;rubricrow&quot;</span><span class="p">,</span> <span class="n">cascade</span><span class="o">=</span><span class="s1">&#39;delete-orphan, delete&#39;</span>
    <span class="p">)</span>  <span class="c1"># type: t.MutableSequence[RubricItem]</span>

    <span class="c1"># This is for the type checker and is available because of a backref.</span>
    <span class="n">assignment</span><span class="p">:</span> <span class="n">Assignment</span>

<div class="viewcode-block" id="RubricRow.__to_json__"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.RubricRow.__to_json__">[docs]</a>    <span class="k">def</span> <span class="nf">__to_json__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Creates a JSON serializable representation of this object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;header&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">,</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
            <span class="s1">&#39;items&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">,</span>
        <span class="p">}</span></div></div>


<div class="viewcode-block" id="RubricItem"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.RubricItem">[docs]</a><span class="k">class</span> <span class="nc">RubricItem</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This class holds the information about a single option/item in a</span>
<span class="sd">    :class:`RubricRow`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="n">query</span> <span class="o">=</span> <span class="n">Base</span><span class="o">.</span><span class="n">query</span>  <span class="c1"># type: t.ClassVar[_MyQuery[&#39;RubricItem&#39;]]</span>

    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;RubricItem&#39;</span>

    <span class="nb">id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">rubricrow_id</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span>
        <span class="s1">&#39;Rubricrow_id&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Integer</span><span class="p">,</span>
        <span class="n">db</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;RubricRow.id&#39;</span><span class="p">,</span> <span class="n">ondelete</span><span class="o">=</span><span class="s1">&#39;CASCADE&#39;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">header</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;header&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;description&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Unicode</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">points</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">db</span><span class="o">.</span><span class="n">Column</span><span class="p">(</span><span class="s1">&#39;points&#39;</span><span class="p">,</span> <span class="n">db</span><span class="o">.</span><span class="n">Float</span><span class="p">)</span>

    <span class="c1"># This variable is generated from the backref from RubricRow</span>
    <span class="n">rubricrow</span><span class="p">:</span> <span class="n">RubricRow</span> <span class="o">=</span> <span class="kc">None</span>

<div class="viewcode-block" id="RubricItem.__to_json__"><a class="viewcode-back" href="../../psef_api/psef.html#psef.models.RubricItem.__to_json__">[docs]</a>    <span class="k">def</span> <span class="nf">__to_json__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">t</span><span class="o">.</span><span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">Any</span><span class="p">]:</span>
        <span class="sd">&quot;&quot;&quot;Creates a JSON serializable representation of this object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="s1">&#39;description&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">description</span><span class="p">,</span>
            <span class="s1">&#39;header&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">header</span><span class="p">,</span>
            <span class="s1">&#39;points&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">points</span><span class="p">,</span>
        <span class="p">}</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2017, Thomas Schaper.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.0',
            LANGUAGE:'None',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  <script type="text/javascript">
      jQuery(function () {
          
          SphinxRtdTheme.Navigation.enableSticky();
          
      });
  </script> 

</body>
</html>